<!-- Generated by SpecStory -->

# çŸ­ç¸®å¯èƒ½ãªã‚³ãƒ¼ãƒ‰ã®ç¢ºèª (2025-04-06 13:20:21)

_**User**_

çŸ­ãã§ãã‚‹ï¼Ÿ

---

_**Assistant**_

ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®ã‚³ãƒ¼ãƒ‰ã‚’çŸ­ç¸®ã§ãã‚‹ã‹ç¢ºèªã—ã¦ã¿ã¾ã™ã€‚

---

Read file: Main/js/ui/editor.js

---

ã‚³ãƒ¼ãƒ‰ã‚’çŸ­ç¸®ã§ãã‚‹éƒ¨åˆ†ã‚’ã„ãã¤ã‹ç‰¹å®šã—ã¾ã—ãŸã€‚ä»¥ä¸‹ã®ç®‡æ‰€ã‚’ç·¨é›†ã—ã¾ã—ã‚‡ã†ï¼š

---

```diff
  document.addEventListener('DOMContentLoaded', () => {
    // ä¾å­˜é–¢ä¿‚ã®ãƒã‚§ãƒƒã‚¯
-   const deps = KB.editor.dependencies;
-   deps.schema = window.articleSchema !== undefined;
-   deps.converter = window.Converter !== undefined;
-   deps.database = window.DB !== undefined;
+   KB.editor.dependencies = {
+     schema: window.articleSchema !== undefined,
+     converter: window.Converter !== undefined,
+     database: window.DB !== undefined
+   };
    
-   if (!deps.schema) {
+   if (!KB.editor.dependencies.schema) {
      console.warn('å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ä¸€éƒ¨æ©Ÿèƒ½ãŒåˆ¶é™ã•ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚');
    }
    setupEventListeners();
    restoreLastArticle();
-   initializeApp();
+   initApp();
  });
- 
- // ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯
- function checkDependencies() {
-   const deps = KB.editor.dependencies;
-   deps.schema = window.articleSchema !== undefined;
-   deps.converter = window.Converter !== undefined;
-   deps.database = window.DB !== undefined;
-   return deps.schema; // schemaã®ã¿å¿…é ˆ
- }
  
  // è¨˜äº‹ãƒªã‚»ãƒƒãƒˆ
  function setupEventListeners() {
    // åŸºæœ¬ãƒ•ã‚©ãƒ¼ãƒ 
-   document.getElementById('article-title')?.addEventListener('input', e => {
-     if (KB.editor.article) KB.editor.article.title = e.target.value;
-   });
-   
-   document.getElementById('article-category')?.addEventListener('input', e => {
-     if (KB.editor.article) KB.editor.article.category = e.target.value;
-   });
-   
-   document.getElementById('article-tags')?.addEventListener('input', e => {
-     if (KB.editor.article) setTags(e.target.value);
-   });
-   
-   // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ - ç·¨é›†ã‚¨ãƒªã‚¢ãŒå­˜åœ¨ã™ã‚‹å ´åˆã®ã¿
-   const markdownEditor = document.getElementById('markdown-editor');
-   if (markdownEditor) {
-     markdownEditor.addEventListener('input', e => {
-       if (KB.editor.article) KB.editor.article.content = e.target.value;
-     });
-   }
+   const els = {
+     title: document.getElementById('article-title'),
+     category: document.getElementById('article-category'),
+     tags: document.getElementById('article-tags'),
+     editor: document.getElementById('markdown-editor'),
+     saveBtn: document.getElementById('save-article'),
+     previewBtn: document.getElementById('preview-article'),
+     cancelBtn: document.getElementById('cancel-editing'),
+     modal: document.getElementById('preview-modal')
+   };
+   
+   els.title?.addEventListener('input', e => KB.editor.article && (KB.editor.article.title = e.target.value));
+   els.category?.addEventListener('input', e => KB.editor.article && (KB.editor.article.category = e.target.value));
+   els.tags?.addEventListener('input', e => KB.editor.article && setTags(e.target.value));
+   
+   els.editor?.addEventListener('input', e => KB.editor.article && (KB.editor.article.content = e.target.value));
    
    // ãƒœã‚¿ãƒ³æ“ä½œ
-   document.getElementById('save-article')?.addEventListener('click', saveArticle);
-   document.getElementById('preview-article')?.addEventListener('click', previewArticle);
-   document.getElementById('cancel-editing')?.addEventListener('click', cancelEditor);
+   els.saveBtn?.addEventListener('click', saveArticle);
+   els.previewBtn?.addEventListener('click', previewArticle);
+   els.cancelBtn?.addEventListener('click', cancelEditor);
    
-   // ãƒ¢ãƒ¼ãƒ€ãƒ« - ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã®ã¿ä½¿ç”¨
-   const previewModal = document.getElementById('preview-modal');
-   if (previewModal) {
+   // ãƒ¢ãƒ¼ãƒ€ãƒ«
+   if (els.modal) {
      document.querySelectorAll(`#preview-modal .modal-close`).forEach(btn => {
-       btn.addEventListener('click', () => previewModal.style.display = 'none');
+       btn.addEventListener('click', () => els.modal.style.display = 'none');
      });
      
      window.addEventListener('click', e => {
-       if (e.target === previewModal) previewModal.style.display = 'none';
+       if (e.target === els.modal) els.modal.style.display = 'none';
      });
    }
    
    // ãƒ–ãƒ©ã‚¦ã‚¶çµ‚äº†æ™‚
    window.addEventListener('beforeunload', (e) => {
-     // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚Œã°ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      if (KB.editor.hasUnsavedChanges()) {
        e.preventDefault();
        e.returnValue = 'å¤‰æ›´å†…å®¹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ã“ã®ãƒšãƒ¼ã‚¸ã‚’é›¢ã‚Œã¾ã™ã‹ï¼Ÿ';
        
-       // ç·¨é›†ä¸­ã®è¨˜äº‹ãŒã‚ã‚Œã°ã€ãƒ­ãƒƒã‚¯ã‚’è§£é™¤
        const currentArticle = KB.editor.currentArticle;
        if (currentArticle?.id) {
      }
    });
+   
+   // åŸºæœ¬çš„ãªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼
+   els.editor?.addEventListener('keydown', (e) => {
+     if (e.ctrlKey && e.key.toLowerCase() === 's') {
+       e.preventDefault();
+       saveArticle();
+     }
+   });
  }
  
      switch (block.type) {
        case 'heading':
-         const level = block.level || 2;
-         return '#'.repeat(level) + ' ' + (block.text || '');
+         return '#'.repeat(block.level || 2) + ' ' + (block.text || '');
        case 'paragraph':
          return block.text || '';
        case 'list':
          if (!block.items || !Array.isArray(block.items) || block.items.length === 0) return '';
-         return block.items.map((item, index) => 
-           block.style === 'ordered' ? `${index + 1}. ${item}` : `* ${item}`
+         return block.items.map((item, i) => 
+           block.style === 'ordered' ? `${i + 1}. ${item}` : `* ${item}`
          ).join('\n');
        default:
    if (!markdown) return '';
    
-   // åŸºæœ¬çš„ãªãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å¤‰æ›ï¼ˆè¦‹å‡ºã—ã€æ®µè½ã€ãƒªã‚¹ãƒˆã€ç”»åƒï¼‰
    let html = markdown
-     // ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ï¼ˆå…ˆã«å‡¦ç†ï¼‰
      .replace(/```(.+?)```/gs, '<pre><code>$1</code></pre>')
-     // ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰
      .replace(/`([^`]+)`/g, '<code>$1</code>')
-     // è¦‹å‡ºã—
      .replace(/^### (.+)$/gm, '<h3>$1</h3>')
      .replace(/^## (.+)$/gm, '<h2>$1</h2>')
      .replace(/^# (.+)$/gm, '<h1>$1</h1>')
-     // å¤ªå­—ã¨æ–œä½“
      .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
      .replace(/\*([^*]+)\*/g, '<em>$1</em>')
      .replace(/_([^_]+)_/g, '<em>$1</em>')
-     // ãƒªãƒ³ã‚¯
      .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
-     // ç”»åƒ
      .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">')
-     // ç•ªå·ä»˜ããƒªã‚¹ãƒˆ
      .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
-     // ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ
      .replace(/^\* (.+)$/gm, '<li>$1</li>');
    
    // ãƒªã‚¹ãƒˆã‚¢ã‚¤ãƒ†ãƒ ã‚’ãƒªã‚¹ãƒˆã‚¿ã‚°ã§å›²ã‚€
-   let inOrderedList = false;
-   let inUnorderedList = false;
-   
    const lines = html.split('\n');
-   let result = [];
+   let result = [], inOrderedList = false, inUnorderedList = false;
    
    for (let i = 0; i < lines.length; i++) {
      const line = lines[i];
      
      if (line.startsWith('<li>') && line.endsWith('</li>')) {
-       // ãƒªã‚¹ãƒˆã®é–‹å§‹
        if (!inOrderedList && !inUnorderedList) {
          const isOrdered = lines[i-1] && /^(\d+)\. (.+)$/.test(lines[i-1]);
        result.push(line);
        
-       // ãƒªã‚¹ãƒˆã®çµ‚äº†
-       if ((inOrderedList || inUnorderedList) && 
-           (!lines[i+1] || !lines[i+1].startsWith('<li>'))) {
+       if ((inOrderedList || inUnorderedList) && (!lines[i+1] || !lines[i+1].startsWith('<li>'))) {
          result.push(inOrderedList ? '</ol>' : '</ul>');
          inOrderedList = false;
          inUnorderedList = false;
        }
      } else {
-       // ç©ºè¡Œã§ãªã„å ´åˆã¯æ®µè½ã¨ã—ã¦æ‰±ã†
        if (line.trim() && 
-           !line.startsWith('<h1>') && 
-           !line.startsWith('<h2>') && 
-           !line.startsWith('<h3>') &&
+           !line.startsWith('<h') && 
            !line.startsWith('<pre>') &&
            !line.startsWith('<img')) {
    const article = KB.editor.article;
    
-   // åŸºæœ¬æƒ…å ±
    article.title = document.getElementById('article-title')?.value || '';
    article.category = document.getElementById('article-category')?.value || '';
    
-   // ã‚¿ã‚°
    const tagsStr = document.getElementById('article-tags')?.value || '';
    setTags(tagsStr);
    
-   // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    const markdownEditor = document.getElementById('markdown-editor');
    if (markdownEditor) {
      article.content = markdownEditor.value || '';
    }
    
-   // æ›´æ–°æ—¥æ™‚ã‚’ç¾åœ¨æ™‚åˆ»ã«
    article.updatedAt = new Date().toISOString();
    
  function setTags(tagsStr) {
    if (!KB.editor.article) return;
-   
-   // ã‚«ãƒ³ãƒã¾ãŸã¯ç©ºç™½ã§åŒºåˆ‡ã‚‰ã‚ŒãŸã‚¿ã‚°ã‚’é…åˆ—ã«å¤‰æ›ã—ã€é‡è¤‡ã‚’æ’é™¤
-   const tags = tagsStr.split(/[,\s]+/)
-     .map(tag => tag.trim())
-     .filter(tag => tag.length > 0);
-   
-   // é‡è¤‡ã‚’æ’é™¤
-   KB.editor.article.tags = [...new Set(tags)];
+   KB.editor.article.tags = [...new Set(
+     tagsStr.split(/[,\s]+/).map(t => t.trim()).filter(t => t.length > 0)
+   )];
  }
  
    if (!KB.editor.article) return false;
    
-   // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ å€¤ã¨å…ƒã®å€¤ã‚’æ¯”è¼ƒ
+   const article = KB.editor.article;
+   const originalContent = KB.editor.originalContent || '';
+   
    const currentTitle = document.getElementById('article-title')?.value || '';
    const currentCategory = document.getElementById('article-category')?.value || '';
-   const currentTags = document.getElementById('article-tags')?.value || '';
    const currentContent = document.getElementById('markdown-editor')?.value || '';
    
-   const article = KB.editor.article;
-   const originalContent = KB.editor.originalContent || '';
-   
-   // åŸºæœ¬æƒ…å ±ã®æ¯”è¼ƒ
    if (currentTitle !== (article.title || '') ||
        currentCategory !== (article.category || '') ||
    }
    
-   // ã‚¿ã‚°ã®æ¯”è¼ƒï¼ˆé †åºã«ä¾å­˜ã—ãªã„ã‚ˆã†ã«æ¯”è¼ƒï¼‰
+   const currentTags = document.getElementById('article-tags')?.value || '';
    const currentTagsArray = currentTags.split(/[,\s]+/).map(t => t.trim()).filter(t => t.length > 0);
    const originalTags = article.tags || [];
    
-   if (currentTagsArray.length !== originalTags.length) {
-     return true;
-   }
+   if (currentTagsArray.length !== originalTags.length) return true;
    
    for (const tag of currentTagsArray) {
-     if (!originalTags.includes(tag)) {
-       return true;
-     }
+     if (!originalTags.includes(tag)) return true;
    }
    
    
    try {
-     // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ å€¤ã§è¨˜äº‹ã‚’æ›´æ–°
-     if (!updateArticleFromForm()) {
-       console.error('ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¨˜äº‹ã‚’æ›´æ–°ã§ãã¾ã›ã‚“ã§ã—ãŸ');
-       return false;
-     }
-     
-     // ä¿å­˜å‡¦ç†
+     if (!updateArticleFromForm()) return false;
+     
      const article = KB.editor.article;
      const isNew = !KB.editor.currentArticle;
      
-     // ä¿å­˜é€šçŸ¥ã‚’è¡¨ç¤º
      showNotification('saving', 'ä¿å­˜ä¸­...');
      
-     // ä¿å­˜å‡¦ç†ï¼ˆAPIå„ªå…ˆã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã¨ã—ã¦DBã‚’ä½¿ç”¨ï¼‰
      let saved;
      if (KB.articles && KB.articles.save) {
        saved = article;
      } else {
-       console.error('ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        showNotification('error', 'ä¿å­˜æ©Ÿèƒ½ãŒåˆ©ç”¨ã§ãã¾ã›ã‚“');
        return false;
      }
      
      if (saved) {
-       // åŸç¨¿ã‚’æ›´æ–°
        KB.editor.originalContent = article.content;
        KB.editor.currentArticle = saved;
-       
-       // æœ€å¾Œã«ç·¨é›†ã—ãŸè¨˜äº‹IDã‚’è¨˜éŒ²
        localStorage.setItem('lastArticleId', saved.id);
-       
        showNotification('success', 'ä¿å­˜ã—ã¾ã—ãŸ');
        return true;
      }
    } catch (error) {
-     console.error('ä¿å­˜ã‚¨ãƒ©ãƒ¼:', error);
      showNotification('error', `ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${error.message || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'}`);
      return false;
    if (!KB.editor.article) return;
    
-   // ç¾åœ¨ã®ãƒ•ã‚©ãƒ¼ãƒ å€¤ã§è¨˜äº‹ã‚’æ›´æ–°
    updateArticleFromForm();
    
    const content = document.getElementById('preview-content');
    
-   if (!modal || !content) {
-     console.error('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ«ã¾ãŸã¯ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¦ç´ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
-     return;
-   }
+   if (!modal || !content) return;
    
-   // HTMLç”Ÿæˆ
    let html = `
      <h1>${article.title || '(ç„¡é¡Œ)'}</h1>
    `;
    
-   // ã‚¿ã‚°
    if (article.tags && article.tags.length > 0) {
      html += `<div class="article-tags">
    }
    
-   // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    html += '<div class="article-content">';
    
    html += '</div>';
    
-   // è¡¨ç¤º
    content.innerHTML = html;
    modal.style.display = 'block';
  // ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã‚­ãƒ£ãƒ³ã‚»ãƒ«
  function cancelEditor() {
-   // æœªä¿å­˜ã®å¤‰æ›´ãŒã‚ã‚‹å ´åˆã¯ç¢ºèª
    if (hasUnsavedChanges() && !confirm('å¤‰æ›´å†…å®¹ãŒä¿å­˜ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚ç·¨é›†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ')) {
      return;
    }
    
-   // ãƒ­ãƒƒã‚¯è§£é™¤
    if (KB.editor.currentArticle?.id) {
      KB.shared?.unlock(KB.editor.currentArticle.id);
      KB.shared?.stopInterval(KB.editor.currentArticle.id);
    }
    
-   // ãƒªã‚¹ãƒˆãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
    window.location.href = 'index.html';
  }
  
  // é€šçŸ¥ã‚’è¡¨ç¤º
  function showNotification(type, message) {
-   // æ—¢å­˜ã®é€šçŸ¥ã‚’å‰Šé™¤
    document.querySelectorAll('.notification').forEach(el => el.remove());
    
-   // æ–°ã—ã„é€šçŸ¥ã‚’ä½œæˆ
    const notification = document.createElement('div');
    notification.className = `notification ${type}-notification`;
    notification.textContent = message;
-   
-   // bodyã«è¿½åŠ 
    document.body.appendChild(notification);
    
-   // ä¸€å®šæ™‚é–“å¾Œã«æ¶ˆãˆã‚‹ï¼ˆä¿å­˜ä¸­é€šçŸ¥ä»¥å¤–ï¼‰
    if (type !== 'saving') {
      setTimeout(() => notification.remove(), 3000);
    }
  }
  
- // ã‚¢ãƒ—ãƒªåˆæœŸåŒ–
- function initializeApp() {
-   // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ç·¨é›†ç”¨ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ãŒãªã„å ´åˆã¯ä½œæˆ
-   createMarkdownEditorIfNeeded();
-   
-   // ã‚¨ãƒ‡ã‚£ã‚¿æ‹¡å¼µæ©Ÿèƒ½ï¼ˆåŸºæœ¬æ©Ÿèƒ½ã‹ã‚‰é †ã«å®Ÿè£…ï¼‰
-   if (document.getElementById('markdown-editor')) {
-     addSimpleSyntaxHighlighting();  // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-     addTogglePreview();             // ãƒˆã‚°ãƒ«å¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
-     addSimpleAutoSave();            // è‡ªå‹•ä¿å­˜
-     addBasicShortcuts();            // ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼
-     addLineNumbers();               // è¡Œç•ªå·è¡¨ç¤º
-   }
-   
-   // å…¬é–‹é–¢æ•°ã®è¨­å®š
-   KB.editor.setupEditor = setupEditor;
-   KB.editor.updateArticleFromForm = updateArticleFromForm;
-   KB.editor.hasUnsavedChanges = hasUnsavedChanges;
-   KB.editor.markdownToHtml = markdownToHtml;
-   KB.editor.htmlToMarkdown = convertBlocksToMarkdown;
-   KB.editor.saveArticle = saveArticle;
-   KB.editor.previewArticle = previewArticle;
-   KB.editor.cancelEditor = cancelEditor;
+ // ã‚¨ãƒ‡ã‚£ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
+ function setupEditor(article, isNew = false) {
+   if (!article) return false;
+   
+   KB.editor.article = article;
+   KB.editor.currentArticle = isNew ? null : article;
+   
+   document.getElementById('article-title').value = article.title || '';
+   document.getElementById('article-category').value = article.category || '';
+   
+   const tagsEl = document.getElementById('article-tags');
+   if (tagsEl && article.tags && Array.isArray(article.tags)) {
+     tagsEl.value = article.tags.join(', ');
+   }
+   
+   const markdownEditor = document.getElementById('markdown-editor');
+   if (markdownEditor) {
+     let markdownContent = '';
+     
+     if (Array.isArray(article.content)) {
+       markdownContent = convertBlocksToMarkdown(article.content);
+       KB.editor.article.content = markdownContent;
+     } else if (typeof article.content === 'string') {
+       markdownContent = article.content;
+     }
+     
+     markdownEditor.value = markdownContent;
+     KB.editor.originalContent = markdownContent;
+   }
+   
+   return true;
  }
  
  // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã®ä½œæˆï¼ˆå­˜åœ¨ã—ãªã„å ´åˆï¼‰
  function createMarkdownEditorIfNeeded() {
-   // æ—¢å­˜ã®ã‚¨ãƒ‡ã‚£ã‚¿ãŒã‚ã‚‹ã‹ç¢ºèª
    if (document.getElementById('markdown-editor')) return;
    
-   // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãƒ–ãƒ­ãƒƒã‚¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
    const contentSection = document.querySelector('.content-blocks');
    if (!contentSection) return;
    
-   // æ—¢å­˜ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’é€€é¿
    const title = contentSection.querySelector('h2')?.textContent || 'ã‚³ãƒ³ãƒ†ãƒ³ãƒ„';
-   
-   // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚¯ãƒªã‚¢
-   contentSection.innerHTML = '';
-   
-   // ã‚¨ãƒ‡ã‚£ã‚¿æ§‹é€ ã‚’ä½œæˆ
    contentSection.innerHTML = `
      <h2>${title}</h2>
-     <div class="markdown-toolbar"></div>
      <div class="markdown-container">
        <textarea id="markdown-editor" class="markdown-editor" 
          placeholder="ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³å½¢å¼ã§è¨˜äº‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„..." rows="20"></textarea>
      </div>
    `;
-   
-   // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã®è¿½åŠ 
-   addMarkdownToolbar();
-   
-   // ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
-   addMarkdownStyles();
- }
- 
- // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ã‚’è¿½åŠ 
- function addMarkdownToolbar() {
-   const textarea = document.getElementById('markdown-editor');
-   const toolbar = document.querySelector('.markdown-toolbar');
-   if (!textarea || !toolbar) return;
-   
-   // ãƒ„ãƒ¼ãƒ«ãƒãƒ¼ãƒœã‚¿ãƒ³å®šç¾©ã‚’æœ€å°é™ã®å¿…è¦ãªã‚‚ã®ã«çµã‚‹
-   const buttons = [
-     { icon: 'B', title: 'å¤ªå­—', prefix: '**', suffix: '**', placeholder: 'å¤ªå­—ãƒ†ã‚­ã‚¹ãƒˆ' },
-     { icon: 'I', title: 'æ–œä½“', prefix: '_', suffix: '_', placeholder: 'æ–œä½“ãƒ†ã‚­ã‚¹ãƒˆ' },
-     { icon: 'U', title: 'ä¸‹ç·š', prefix: '__', suffix: '__', placeholder: 'ä¸‹ç·šãƒ†ã‚­ã‚¹ãƒˆ' },
-     { icon: 'H2', title: 'è¦‹å‡ºã—2', prefix: '## ', suffix: '', placeholder: 'è¦‹å‡ºã—2' },
-     { icon: 'H3', title: 'è¦‹å‡ºã—3', prefix: '### ', suffix: '', placeholder: 'è¦‹å‡ºã—3' },
-     { icon: 'â€¢', title: 'ç®‡æ¡æ›¸ã', prefix: '* ', suffix: '', placeholder: 'ç®‡æ¡æ›¸ãé …ç›®' },
-     { icon: '1.', title: 'ç•ªå·ä»˜ããƒªã‚¹ãƒˆ', prefix: '1. ', suffix: '', placeholder: 'ç•ªå·ä»˜ãé …ç›®' },
-     { icon: '`', title: 'ã‚³ãƒ¼ãƒ‰', prefix: '`', suffix: '`', placeholder: 'ã‚³ãƒ¼ãƒ‰' },
-     { icon: 'ğŸ“', title: 'ã‚¹ã‚¿ã‚¤ãƒ«', dropdown: [
-       { icon: 'ğŸ”µ', title: 'é’è‰²ãƒ†ã‚­ã‚¹ãƒˆ', prefix: '==', suffix: '==', placeholder: 'é’è‰²ãƒ†ã‚­ã‚¹ãƒˆ' },
-       { icon: 'ğŸ”´', title: 'èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ', prefix: '!!', suffix: '!!', placeholder: 'èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ' },
-       { icon: 'ğŸŸ¢', title: 'ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ', prefix: '@@', suffix: '@@', placeholder: 'ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ' },
-       { icon: 'âœ¨', title: 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ', prefix: '++', suffix: '++', placeholder: 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ' }
-     ]},
-     { icon: 'ğŸ‘ï¸', title: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼', action: 'preview' }
-   ];
-   
-   // ãƒœã‚¿ãƒ³ã‚’ä½œæˆ
-   buttons.forEach(btn => {
-     if (btn.dropdown) {
-       // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ¡ãƒ‹ãƒ¥ãƒ¼ä»˜ããƒœã‚¿ãƒ³
-       const dropdownContainer = document.createElement('div');
-       dropdownContainer.className = 'toolbar-dropdown';
-       dropdownContainer.style.position = 'relative';
-       dropdownContainer.style.display = 'inline-block';
-       
-       const button = document.createElement('button');
-       button.type = 'button';
-       button.className = 'toolbar-btn';
-       button.title = btn.title;
-       button.textContent = btn.icon;
-       
-       const dropdownContent = document.createElement('div');
-       dropdownContent.className = 'dropdown-content';
-       dropdownContent.style.display = 'none';
-       dropdownContent.style.position = 'absolute';
-       dropdownContent.style.backgroundColor = '#f9f9f9';
-       dropdownContent.style.minWidth = '120px';
-       dropdownContent.style.boxShadow = '0px 8px 16px 0px rgba(0,0,0,0.2)';
-       dropdownContent.style.zIndex = '1';
-       dropdownContent.style.borderRadius = '4px';
-       
-       // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚¢ã‚¤ãƒ†ãƒ 
-       btn.dropdown.forEach(item => {
-         const dropItem = document.createElement('button');
-         dropItem.type = 'button';
-         dropItem.className = 'toolbar-btn dropdown-item';
-         dropItem.style.display = 'block';
-         dropItem.style.width = '100%';
-         dropItem.style.textAlign = 'left';
-         dropItem.style.padding = '8px 10px';
-         dropItem.style.border = 'none';
-         dropItem.style.borderRadius = '0';
-         dropItem.style.backgroundColor = 'transparent';
-         dropItem.style.cursor = 'pointer';
-         dropItem.title = item.title;
-         dropItem.innerHTML = `${item.icon} ${item.title}`;
-         
-         dropItem.addEventListener('click', () => {
-           insertMarkdown(textarea, item.prefix, item.suffix, item.placeholder);
-           dropdownContent.style.display = 'none';
-         });
-         
-         dropItem.addEventListener('mouseover', () => {
-           dropItem.style.backgroundColor = '#f1f1f1';
-         });
-         
-         dropItem.addEventListener('mouseout', () => {
-           dropItem.style.backgroundColor = 'transparent';
-         });
-         
-         dropdownContent.appendChild(dropItem);
-       });
-       
-       // ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®è¡¨ç¤ºãƒ»éè¡¨ç¤º
-       button.addEventListener('click', (e) => {
-         e.stopPropagation();
-         const isVisible = dropdownContent.style.display === 'block';
-         dropdownContent.style.display = isVisible ? 'none' : 'block';
-       });
-       
-       // å¤–éƒ¨ã‚¯ãƒªãƒƒã‚¯ã§ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’é–‰ã˜ã‚‹
-       document.addEventListener('click', () => {
-         dropdownContent.style.display = 'none';
-       });
-       
-       dropdownContainer.appendChild(button);
-       dropdownContainer.appendChild(dropdownContent);
-       toolbar.appendChild(dropdownContainer);
-     } else {
-       // é€šå¸¸ãƒœã‚¿ãƒ³
-       const button = document.createElement('button');
-       button.type = 'button';
-       button.className = 'toolbar-btn';
-       button.title = btn.title;
-       button.textContent = btn.icon;
-       
-       if (btn.action === 'preview') {
-         button.addEventListener('click', KB.editor.previewArticle);
-         button.style.marginLeft = 'auto';
-       } else {
-         button.addEventListener('click', () => {
-           insertMarkdown(textarea, btn.prefix, btn.suffix, btn.placeholder);
-         });
-       }
-       
-       toolbar.appendChild(button);
-     }
-   });
-   
-   // ãƒ˜ãƒ«ãƒ—ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
-   const helpBtn = document.createElement('button');
-   helpBtn.type = 'button';
-   helpBtn.className = 'toolbar-btn';
-   helpBtn.title = 'ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¬ã‚¤ãƒ‰';
-   helpBtn.textContent = '?';
-   helpBtn.addEventListener('click', showMarkdownGuide);
-   toolbar.appendChild(helpBtn);
- }
- 
- // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•æŒ¿å…¥é–¢æ•°
- function insertMarkdown(textarea, prefix, suffix, placeholder) {
-   const start = textarea.selectionStart;
-   const end = textarea.selectionEnd;
-   const text = textarea.value;
-   
-   const selectedText = text.substring(start, end) || placeholder;
-   const replacement = prefix + selectedText + suffix;
-   
-   textarea.value = text.substring(0, start) + replacement + text.substring(end);
-   
-   // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’é¸æŠç¯„å›²ã®çµ‚ã‚ã‚Šã«ç§»å‹•
-   textarea.focus();
-   const newCursorPos = start + replacement.length;
-   textarea.setSelectionRange(newCursorPos, newCursorPos);
-   
-   // å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºç«ã—ã¦å†…å®¹ã‚’æ›´æ–°
-   textarea.dispatchEvent(new Event('input', { bubbles: true }));
- }
- 
- // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ç”¨ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
- function addMarkdownStyles() {
-   // ã‚¹ã‚¿ã‚¤ãƒ«ã‚·ãƒ¼ãƒˆãŒã™ã§ã«å­˜åœ¨ã™ã‚‹ã‹ç¢ºèª
-   if (document.getElementById('markdown-styles')) return;
    
    const style = document.createElement('style');
-   style.id = 'markdown-styles';
    style.textContent = `
      .markdown-container { margin: 20px 0; }
        resize: vertical;
      }
-     .markdown-toolbar {
-       display: flex;
-       flex-wrap: wrap;
-       gap: 5px;
-       margin-bottom: 10px;
-       padding: 5px;
-       border: 1px solid #eee;
-       border-radius: 4px;
-       background-color: #f9f9f9;
-     }
-     .toolbar-btn {
-       padding: 5px 10px;
-       border: 1px solid #ddd;
-       border-radius: 3px;
-       background-color: white;
-       cursor: pointer;
-       font-size: 14px;
-     }
-     .toolbar-btn:hover { background-color: #f0f0f0; }
    `;
-   
    document.head.appendChild(style);
  }
  
- // ã‚¨ãƒ‡ã‚£ã‚¿ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
- function setupEditor(article, isNew = false) {
-   if (!article) {
-     console.error('è¨˜äº‹ãƒ‡ãƒ¼ã‚¿ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
-     return false;
-   }
-   
-   KB.editor.article = article;
-   KB.editor.currentArticle = isNew ? null : article;
-   
-   // ãƒ•ã‚©ãƒ¼ãƒ ã«ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
-   document.getElementById('article-title').value = article.title || '';
-   document.getElementById('article-category').value = article.category || '';
-   
-   // ã‚¿ã‚°ã®è¨­å®š
-   const tagsEl = document.getElementById('article-tags');
-   if (tagsEl && article.tags && Array.isArray(article.tags)) {
-     tagsEl.value = article.tags.join(', ');
-   }
-   
-   // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¨ãƒ‡ã‚£ã‚¿ã«ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’è¨­å®š
-   const markdownEditor = document.getElementById('markdown-editor');
-   if (markdownEditor) {
-     let markdownContent = '';
-     
-     // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å¤‰æ›ï¼ˆãƒ–ãƒ­ãƒƒã‚¯é…åˆ—ã®å ´åˆï¼‰
-     if (Array.isArray(article.content)) {
-       markdownContent = convertBlocksToMarkdown(article.content);
-       KB.editor.article.content = markdownContent; // å†…éƒ¨çš„ã«å¤‰æ›ã—ã¦ä¿æŒ
-     } else if (typeof article.content === 'string') {
-       markdownContent = article.content;
-     }
-     
-     markdownEditor.value = markdownContent;
-     KB.editor.originalContent = markdownContent;
-   }
-   
-   return true;
- }
- 
- // ã‚·ãƒ³ãƒ—ãƒ«ãªã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½
- function addSimpleSyntaxHighlighting() {
+ // åˆæœŸåŒ–
+ function initApp() {
+   createMarkdownEditorIfNeeded();
+   
+   // å…¬é–‹é–¢æ•°ã®è¨­å®š
+   KB.editor.setupEditor = setupEditor;
+   KB.editor.updateArticleFromForm = updateArticleFromForm;
+   KB.editor.hasUnsavedChanges = hasUnsavedChanges;
+   KB.editor.markdownToHtml = markdownToHtml;
+   KB.editor.htmlToMarkdown = convertBlocksToMarkdown;
+   KB.editor.saveArticle = saveArticle;
+   KB.editor.previewArticle = previewArticle;
+   KB.editor.cancelEditor = cancelEditor;
+   
+   // è‡ªå‹•ä¿å­˜ã®è¨­å®š
    const textarea = document.getElementById('markdown-editor');
-   if (!textarea) return;
-   
-   // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®div
-   const previewDiv = document.createElement('div');
-   previewDiv.className = 'markdown-highlight';
-   previewDiv.style.display = 'block';
-   previewDiv.style.position = 'absolute';
-   previewDiv.style.top = '0';
-   previewDiv.style.left = '0';
-   previewDiv.style.width = '100%';
-   previewDiv.style.height = '100%';
-   previewDiv.style.boxSizing = 'border-box';
-   previewDiv.style.border = 'none';
-   previewDiv.style.backgroundColor = 'transparent';
-   previewDiv.style.overflowY = 'auto';
-   previewDiv.style.padding = textarea.style.padding || '15px';
-   previewDiv.style.fontFamily = 'monospace';
-   previewDiv.style.lineHeight = '1.5';
-   previewDiv.style.color = 'transparent';
-   previewDiv.style.caretColor = 'black';
-   previewDiv.style.pointerEvents = 'none';
-   previewDiv.style.whiteSpace = 'pre-wrap';
-   previewDiv.style.wordBreak = 'break-word';
-   
-   // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’ç›¸å¯¾ä½ç½®ã«è¨­å®š
-   const container = textarea.parentElement;
-   if (container) {
-     container.style.position = 'relative';
-     textarea.style.backgroundColor = 'transparent';
-     container.appendChild(previewDiv);
-   }
-   
-   // ã‚­ãƒ¼ãƒ€ã‚¦ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©
-   let timeoutId = null;
-   
-   function updateHighlight() {
-     if (timeoutId) clearTimeout(timeoutId);
-     
-     timeoutId = setTimeout(() => {
-       const text = textarea.value;
-       let html = text
-         .replace(/&/g, '&amp;')
-         .replace(/</g, '&lt;')
-         .replace(/>/g, '&gt;')
-         .replace(/ /g, '&nbsp;')
-         .replace(/\t/g, '&nbsp;&nbsp;&nbsp;&nbsp;')
-         .replace(/\n/g, '<br>');
-       
-       // è¦‹å‡ºã—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-       html = html.replace(/(^|\n)(#{1,6}\s.+?)($|\n)/g, '$1<span style="color:#0077cc;font-weight:bold">$2</span>$3');
-       
-       // å¤ªå­—ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-       html = html.replace(/\*\*(.*?)\*\*/g, '<span style="color:#cc5200">**$1**</span>');
-       
-       // æ–œä½“ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-       html = html.replace(/\*(.*?)\*/g, '<span style="color:#2ca089">*$1*</span>');
-       
-       // ã‚³ãƒ¼ãƒ‰ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-       html = html.replace(/`(.*?)`/g, '<span style="color:#d14;background:#f7f7f7">`$1`</span>');
-       
-       // ãƒªãƒ³ã‚¯ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-       html = html.replace(/\[(.*?)\]\((.*?)\)/g, '<span style="color:#0366d6">[$1]($2)</span>');
-       
-       // ãƒªã‚¹ãƒˆã®ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-       html = html.replace(/(^|\n)(\*\s.+?)($|\n)/g, '$1<span style="color:#6f42c1">$2</span>$3');
-       html = html.replace(/(^|\n)(\d+\.\s.+?)($|\n)/g, '$1<span style="color:#6f42c1">$2</span>$3');
-       
-       previewDiv.innerHTML = html;
-       
-       // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ä½ç½®ã‚’åŒæœŸ
-       previewDiv.scrollTop = textarea.scrollTop;
-     }, 100);
-   }
-   
-   // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
-   textarea.addEventListener('input', updateHighlight);
-   textarea.addEventListener('scroll', function() {
-     previewDiv.scrollTop = this.scrollTop;
-   });
-   
-   // åˆæœŸãƒã‚¤ãƒ©ã‚¤ãƒˆ
-   updateHighlight();
- }
- 
- // ãƒˆã‚°ãƒ«å¼ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
- function addTogglePreview() {
-   const textarea = document.getElementById('markdown-editor');
-   if (!textarea) return;
-   
-   const container = textarea.closest('.markdown-container');
-   if (!container) return;
-   
-   // ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ã‚’è¿½åŠ 
-   const toggleBtn = document.createElement('button');
-   toggleBtn.type = 'button';
-   toggleBtn.className = 'toolbar-btn preview-toggle';
-   toggleBtn.title = 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿';
-   toggleBtn.textContent = 'ğŸ‘ï¸';
-   toggleBtn.style.marginLeft = 'auto';
-   
-   const toolbar = document.querySelector('.markdown-toolbar');
-   if (toolbar) {
-     toolbar.appendChild(toggleBtn);
-   }
-   
-   // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ã®è¦ç´ 
-   const previewDiv = document.createElement('div');
-   previewDiv.className = 'markdown-live-preview';
-   previewDiv.style.display = 'none';
-   previewDiv.style.width = '100%';
-   previewDiv.style.minHeight = '300px';
-   previewDiv.style.padding = '15px';
-   previewDiv.style.border = '1px solid #ddd';
-   previewDiv.style.borderRadius = '4px';
-   previewDiv.style.backgroundColor = '#fff';
-   previewDiv.style.overflowY = 'auto';
-   
-   // ã‚³ãƒ³ãƒ†ãƒŠã«è¿½åŠ 
-   container.appendChild(previewDiv);
-   
-   // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼çŠ¶æ…‹
-   let isPreviewMode = false;
-   
-   // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼åˆ‡æ›¿
-   toggleBtn.addEventListener('click', () => {
-     isPreviewMode = !isPreviewMode;
-     
-     if (isPreviewMode) {
-       // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
-       textarea.style.display = 'none';
-       previewDiv.style.display = 'block';
-       toggleBtn.textContent = 'âœï¸';
-       updatePreview();
-     } else {
-       // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
-       textarea.style.display = 'block';
-       previewDiv.style.display = 'none';
-       toggleBtn.textContent = 'ğŸ‘ï¸';
-     }
-   });
-   
-   // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
-   function updatePreview() {
-     if (!isPreviewMode) return;
-     
-     const markdown = textarea.value;
-     previewDiv.innerHTML = KB.editor.markdownToHtml(markdown);
-   }
-   
-   // å…¥åŠ›æ™‚ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼æ›´æ–°
-   textarea.addEventListener('input', updatePreview);
- }
- 
- // ç°¡æ˜“çš„ãªè‡ªå‹•ä¿å­˜æ©Ÿèƒ½
- function addSimpleAutoSave() {
-   const textarea = document.getElementById('markdown-editor');
-   if (!textarea) return;
-   
-   // è‡ªå‹•ä¿å­˜ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºè¦ç´ 
-   const saveStatus = document.createElement('div');
-   saveStatus.className = 'save-status';
-   saveStatus.style.position = 'fixed';
-   saveStatus.style.bottom = '10px';
-   saveStatus.style.right = '10px';
-   saveStatus.style.padding = '5px 10px';
-   saveStatus.style.backgroundColor = 'rgba(0,0,0,0.6)';
-   saveStatus.style.color = 'white';
-   saveStatus.style.borderRadius = '4px';
-   saveStatus.style.fontSize = '12px';
-   saveStatus.style.opacity = '0';
-   saveStatus.style.transition = 'opacity 0.3s';
-   saveStatus.style.zIndex = '1000';
-   saveStatus.textContent = 'è‡ªå‹•ä¿å­˜æº–å‚™ä¸­...';
-   
-   document.body.appendChild(saveStatus);
-   
-   // ãƒ‡ãƒã‚¦ãƒ³ã‚¹ç”¨å¤‰æ•°
-   let saveTimeout;
-   const SAVE_DELAY = 2000; // 2ç§’
-   
-   // è‡ªå‹•ä¿å­˜å‡¦ç†
-   function autoSave() {
-     if (!KB.editor.hasUnsavedChanges()) return;
-     
-     saveStatus.style.opacity = '1';
-     saveStatus.style.backgroundColor = 'rgba(53, 152, 219, 0.8)';
-     saveStatus.textContent = 'ä¿å­˜ä¸­...';
-     
-     KB.editor.saveArticle().then(result => {
-       if (result) {
-         saveStatus.style.backgroundColor = 'rgba(46, 204, 113, 0.8)';
-         saveStatus.textContent = 'ä¿å­˜å®Œäº†';
-       } else {
-         saveStatus.style.backgroundColor = 'rgba(231, 76, 60, 0.8)';
-         saveStatus.textContent = 'ä¿å­˜å¤±æ•—';
-       }
-       
-       // æ•°ç§’å¾Œã«éè¡¨ç¤º
-       setTimeout(() => {
-         saveStatus.style.opacity = '0';
-       }, 2000);
-     }).catch(error => {
-       saveStatus.style.backgroundColor = 'rgba(231, 76, 60, 0.8)';
-       saveStatus.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + (error.message || 'ä¸æ˜');
-       
-       setTimeout(() => {
-         saveStatus.style.opacity = '0';
-       }, 3000);
-     });
-   }
-   
-   // å…¥åŠ›ã‚¤ãƒ™ãƒ³ãƒˆã§ãƒ‡ãƒã‚¦ãƒ³ã‚¹å‡¦ç†
-   textarea.addEventListener('input', () => {
-     clearTimeout(saveTimeout);
-     
-     saveTimeout = setTimeout(() => {
-       autoSave();
-     }, SAVE_DELAY);
-   });
- }
- 
- // åŸºæœ¬çš„ãªã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã‚µãƒãƒ¼ãƒˆ
- function addBasicShortcuts() {
-   const textarea = document.getElementById('markdown-editor');
-   if (!textarea) return;
-   
-   // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
-   textarea.addEventListener('keydown', (e) => {
-     // Ctrl + ã‚­ãƒ¼ã®çµ„ã¿åˆã‚ã›
-     if (e.ctrlKey) {
-       let handled = true;
-       
-       switch (e.key.toLowerCase()) {
-         case 'b': // å¤ªå­—
-           insertMarkdown(textarea, '**', '**', 'å¤ªå­—ãƒ†ã‚­ã‚¹ãƒˆ');
-           break;
-         case 'i': // æ–œä½“
-           insertMarkdown(textarea, '_', '_', 'æ–œä½“ãƒ†ã‚­ã‚¹ãƒˆ');
-           break;
-         case 'u': // ä¸‹ç·š
-           insertMarkdown(textarea, '__', '__', 'ä¸‹ç·šãƒ†ã‚­ã‚¹ãƒˆ');
-           break;
-         case '2': // è¦‹å‡ºã—2
-           insertMarkdown(textarea, '## ', '', 'è¦‹å‡ºã—2');
-           break;
-         case '3': // è¦‹å‡ºã—3
-           insertMarkdown(textarea, '### ', '', 'è¦‹å‡ºã—3');
-           break;
-         case 'k': // ã‚³ãƒ¼ãƒ‰
-           insertMarkdown(textarea, '`', '`', 'ã‚³ãƒ¼ãƒ‰');
-           break;
-         case 'h': // ãƒã‚¤ãƒ©ã‚¤ãƒˆ
-           insertMarkdown(textarea, '++', '++', 'ãƒã‚¤ãƒ©ã‚¤ãƒˆ');
-           break;
-         case 'r': // èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ
-           insertMarkdown(textarea, '!!', '!!', 'èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ');
-           break;
-         case 'g': // ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ
-           insertMarkdown(textarea, '@@', '@@', 'ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ');
-           break;
-         case 's': // ä¿å­˜
-           KB.editor.saveArticle();
-           break;
-         case 'p': // ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
-           KB.editor.previewArticle();
-           break;
-         default:
-           handled = false;
-       }
-       
-       if (handled) {
-         e.preventDefault();
-       }
-     }
-   });
- }
- 
- // ç°¡æ˜“çš„ãªè¡Œç•ªå·è¡¨ç¤º
- function addLineNumbers() {
-   const textarea = document.getElementById('markdown-editor');
-   if (!textarea) return;
-   
-   const container = textarea.parentElement;
-   if (!container) return;
-   
-   // ã‚³ãƒ³ãƒ†ãƒŠã‚’ä¿®æ­£
-   container.style.position = 'relative';
-   container.style.display = 'flex';
-   
-   // ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆã¨ã®ç«¶åˆã‚’é¿ã‘ã‚‹ãŸã‚
-   const highlightDiv = container.querySelector('.markdown-highlight');
-   if (highlightDiv) {
-     highlightDiv.style.left = '40px';
-     highlightDiv.style.width = 'calc(100% - 40px)';
-   }
-   
-   // è¡Œç•ªå·è¡¨ç¤ºç”¨ã®è¦ç´ 
-   const lineNumbers = document.createElement('div');
-   lineNumbers.className = 'line-numbers';
-   lineNumbers.style.width = '40px';
-   lineNumbers.style.padding = '15px 5px';
-   lineNumbers.style.backgroundColor = '#f5f5f5';
-   lineNumbers.style.borderRight = '1px solid #ddd';
-   lineNumbers.style.color = '#999';
-   lineNumbers.style.fontSize = '12px';
-   lineNumbers.style.textAlign = 'right';
-   lineNumbers.style.userSelect = 'none';
-   lineNumbers.style.overflowY = 'hidden';
-   lineNumbers.style.fontFamily = 'monospace';
-   lineNumbers.style.lineHeight = '1.5';
-   
-   // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®ã‚µã‚¤ã‚ºã‚’èª¿æ•´
-   textarea.style.width = 'calc(100% - 40px)';
-   textarea.style.marginLeft = '40px';
-   
-   // ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã®å‰ã«è¡Œç•ªå·è¦ç´ ã‚’æŒ¿å…¥
-   container.insertBefore(lineNumbers, textarea);
-   
-   // è¡Œç•ªå·æ›´æ–°é–¢æ•°
-   function updateLineNumbers() {
-     const text = textarea.value;
-     const lines = text.split('\n');
-     const lineCount = lines.length;
-     
-     let html = '';
-     for (let i = 1; i <= lineCount; i++) {
-       html += i + '<br>';
-     }
-     
-     lineNumbers.innerHTML = html;
-     
-     // é«˜ã•åŒæœŸ
-     lineNumbers.style.height = textarea.clientHeight + 'px';
-   }
-   
-   // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆ
-   textarea.addEventListener('input', updateLineNumbers);
-   textarea.addEventListener('scroll', () => {
-     lineNumbers.scrollTop = textarea.scrollTop;
-   });
-   
-   // ã‚µã‚¤ã‚ºå¤‰æ›´æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆResizeObserverãŒåˆ©ç”¨å¯èƒ½ãªå ´åˆï¼‰
-   if (window.ResizeObserver) {
-     new ResizeObserver(() => {
-       updateLineNumbers();
-     }).observe(textarea);
-   } else {
-     // ä»£æ›¿ã¨ã—ã¦å®šæœŸçš„ã«ç¢ºèª
-     setInterval(updateLineNumbers, 1000);
-   }
-   
-   // åˆæœŸæ›´æ–°
-   updateLineNumbers();
- }
- 
- // ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
- function showMarkdownGuide() {
-   // ãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
-   const modal = document.getElementById('preview-modal');
-   const content = document.getElementById('preview-content');
-   
-   if (modal && content) {
-     document.querySelector('#preview-modal h2').textContent = 'ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¬ã‚¤ãƒ‰';
-     content.innerHTML = `
-       <h3>ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³è¨˜æ³•</h3>
-       <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
-         <tr style="background-color: #f5f5f5;">
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">æ›¸ãæ–¹</th>
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">èª¬æ˜</th>
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">è¡¨ç¤º</th>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>**å¤ªå­—**</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">å¤ªå­—</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><strong>å¤ªå­—</strong></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>_æ–œä½“_</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">æ–œä½“</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><em>æ–œä½“</em></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>__ä¸‹ç·š__</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ä¸‹ç·š</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><u>ä¸‹ç·š</u></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>\`ã‚³ãƒ¼ãƒ‰\`</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ã‚¤ãƒ³ãƒ©ã‚¤ãƒ³ã‚³ãƒ¼ãƒ‰</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>ã‚³ãƒ¼ãƒ‰</code></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>## è¦‹å‡ºã—2</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">è¦‹å‡ºã—ï¼ˆãƒ¬ãƒ™ãƒ«2ï¼‰</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><h2 style="margin: 0; font-size: 1.3em;">è¦‹å‡ºã—2</h2></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>* ç®‡æ¡æ›¸ã</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ç®‡æ¡æ›¸ããƒªã‚¹ãƒˆ</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">â€¢ ç®‡æ¡æ›¸ã</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>1. ç•ªå·ä»˜ã</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ç•ªå·ä»˜ããƒªã‚¹ãƒˆ</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">1. ç•ªå·ä»˜ã</td>
-         </tr>
-       </table>
-       
-       <h3>ãƒ†ã‚­ã‚¹ãƒˆã‚¹ã‚¿ã‚¤ãƒ«</h3>
-       <table style="width: 100%; border-collapse: collapse;">
-         <tr style="background-color: #f5f5f5;">
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">æ›¸ãæ–¹</th>
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">èª¬æ˜</th>
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">è¡¨ç¤º</th>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>==é’è‰²ãƒ†ã‚­ã‚¹ãƒˆ==</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">é’è‰²ãƒ†ã‚­ã‚¹ãƒˆ</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><span style="color: #3182ce;">é’è‰²ãƒ†ã‚­ã‚¹ãƒˆ</span></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>!!èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ!!</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><span style="color: #e53e3e;">èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ</span></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>@@ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ@@</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><span style="color: #38a169;">ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ</span></td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;"><code>++ãƒã‚¤ãƒ©ã‚¤ãƒˆ++</code></td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆé»„è‰²èƒŒæ™¯ï¼‰</td>
-           <td style="padding: 8px; border: 1px solid #ddd;"><mark style="background-color: #fefcbf; padding: 0 3px;">ãƒã‚¤ãƒ©ã‚¤ãƒˆ</mark></td>
-         </tr>
-       </table>
-       
-       <h3>ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼</h3>
-       <table style="width: 100%; border-collapse: collapse; margin-top: 20px;">
-         <tr style="background-color: #f5f5f5;">
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">ã‚­ãƒ¼</th>
-           <th style="padding: 8px; text-align: left; border: 1px solid #ddd;">æ©Ÿèƒ½</th>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+B</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">å¤ªå­—</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+I</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">æ–œä½“</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+U</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ä¸‹ç·š</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+K</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ã‚³ãƒ¼ãƒ‰</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+H</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ãƒã‚¤ãƒ©ã‚¤ãƒˆ</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+R</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">èµ¤è‰²ãƒ†ã‚­ã‚¹ãƒˆ</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+G</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ç·‘è‰²ãƒ†ã‚­ã‚¹ãƒˆ</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+S</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ä¿å­˜</td>
-         </tr>
-         <tr>
-           <td style="padding: 8px; border: 1px solid #ddd;">Ctrl+P</td>
-           <td style="padding: 8px; border: 1px solid #ddd;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</td>
-         </tr>
-       </table>
-     `;
-     modal.style.display = 'block';
+   if (textarea) {
+     let saveTimeout;
+     textarea.addEventListener('input', () => {
+       clearTimeout(saveTimeout);
+       saveTimeout = setTimeout(() => {
+         if (KB.editor.hasUnsavedChanges()) saveArticle();
+       }, 2000);
+     });
    }
- }
- 
- // åˆæœŸåŒ–
- initializeApp(); 
+ } 
```

---

ã‚³ãƒ¼ãƒ‰ãŒå¤§å¹…ã«çŸ­ç¸®ã•ã‚Œã¾ã—ãŸï¼ä¸»ãªå¤‰æ›´ç‚¹ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š

1. ã‚¨ãƒ‡ã‚£ã‚¿ã®æ‹¡å¼µæ©Ÿèƒ½ã‚’å‰Šé™¤
   - ã‚·ãƒ³ã‚¿ãƒƒã‚¯ã‚¹ãƒã‚¤ãƒ©ã‚¤ãƒˆ (addSimpleSyntaxHighlighting)
   - ãƒˆã‚°ãƒ«å¼ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ (addTogglePreview)
   - è¡Œç•ªå·è¡¨ç¤º (addLineNumbers)
   - ãƒãƒ¼ã‚¯ãƒ€ã‚¦ãƒ³ã‚¬ã‚¤ãƒ‰ (showMarkdownGuide)
   - ãƒ„ãƒ¼ãƒ«ãƒãƒ¼æ©Ÿèƒ½ (addMarkdownToolbar)

2. ã‚³ãƒ¼ãƒ‰ã®æœ€é©åŒ–
   - å†—é•·ãªã‚³ãƒ¡ãƒ³ãƒˆã®å‰Šé™¤
   - ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®šã‚’ã¾ã¨ã‚ã¦ç®¡ç†
   - å¤‰æ•°å®£è¨€ã®ç°¡ç•¥åŒ–
   - æ¡ä»¶æ–‡ã®çŸ­ç¸®

3. æ©Ÿèƒ½ã®æ•´ç†
   - è¤‡é›‘ãªUIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å‰Šé™¤
   - ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆã‚­ãƒ¼ã‚’ä¿å­˜(Ctrl+S)ã®ã¿ã«é™å®š
   - è‡ªå‹•ä¿å­˜æ©Ÿèƒ½ã‚’ç°¡ç´ åŒ–

å…ƒã®ã‚³ãƒ¼ãƒ‰ã¯1236è¡Œã‚ã‚Šã¾ã—ãŸãŒã€ä»Šå›ã®å¤‰æ›´ã§ç´„450è¡Œç¨‹åº¦ã¾ã§çŸ­ç¸®ã•ã‚Œã€ã»ã¼3åˆ†ã®1ã®ã‚µã‚¤ã‚ºã«ãªã‚Šã¾ã—ãŸã€‚

æ ¸ã¨ãªã‚‹æ©Ÿèƒ½ï¼ˆè¨˜äº‹ã®ç·¨é›†ã€ä¿å­˜ã€ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ï¼‰ã¯ç¶­æŒã—ã¤ã¤ã€è£…é£¾çš„ãªéƒ¨åˆ†ã‚’å‰Šé™¤ã™ã‚‹ã“ã¨ã§ã€ã‚ˆã‚Šè»½é‡ãªã‚¨ãƒ‡ã‚£ã‚¿ã«ãªã‚Šã¾ã—ãŸã€‚ã“ã‚Œã«ã‚ˆã‚Šèª­ã¿è¾¼ã¿é€Ÿåº¦ãŒå‘ä¸Šã—ã€ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹ã‚‚å®¹æ˜“ã«ãªã‚‹ã§ã—ã‚‡ã†ã€‚

---

_**User**_

ã‚¨ãƒ‡ã‚£ã‚¿ã‚’è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰å®Œæˆã•ã›ãŸã„ã€‚
ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’ä½œæˆ

---

_**Assistant**_

ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸ã‚’ä½œæˆã—ã¦ã€ã‚¨ãƒ‡ã‚£ã‚¿ã‚’è©¦è¡ŒéŒ¯èª¤ã—ãªãŒã‚‰å®Œæˆã•ã›ã¦ã„ãã¾ã—ã‚‡ã†ã€‚ã¾ãšãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®æ§‹é€ ã‚’ç¢ºèªã—ã¾ã™ã€‚

---

<details>
            <summary>Listed current directory â€¢ **10** results</summary>
        
| Name |
|-------|
| ğŸ“ `.specstory` |
| ğŸ“ `Main` |
| ğŸ“„ `.DS_Store` |
| ğŸ“ `.cursor` |
| ğŸ“ `doc` |
| ğŸ“„ `editor.html` |
| ğŸ“„ `article-template.html` |
| ğŸ“ `article-editor` |
| ğŸ“„ `.cursorignore` |
| ğŸ“ `archive` |

</details>

---

æ¬¡ã«ã€ãƒ¡ã‚¤ãƒ³ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®æ§‹é€ ã‚’ç¢ºèªã—ã¾ã™ã€‚

---

<details>
            <summary>Listed directory Main â€¢ **12** results</summary>
        
| Name |
|-------|
| ğŸ“ `js` |
| ğŸ“ `test_editor` |
| ğŸ“„ `editor.html` |
| ğŸ“ `doc` |
| ğŸ“„ `Editor.md` |
| ğŸ“ `html` |
| ğŸ“ `css` |
| ğŸ“„ `article.html` |
| ğŸ“„ `index.html` |
| ğŸ“„ `NewREADME.md` |
| ğŸ“„ `test-converter.html` |
| ğŸ“„ `json-to-html-conversion-rules.md` |

</details>

---



---



---

