<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ナレッジベース - マークダウンエディタ</title>
    <style>
        body { font-family: sans-serif; max-width: 960px; margin: 0 auto; padding: 20px; }
        .header { padding: 15px 0; border-bottom: 1px solid #ddd; margin-bottom: 20px; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        textarea { min-height: 300px; font-family: monospace; resize: vertical; }
        .btn { padding: 8px 16px; border: none; border-radius: 4px; color: white; cursor: pointer; margin-right: 10px; }
        .btn-save { background-color: #2ecc71; }
        .btn-preview { background-color: #9b59b6; }
        .btn-export { background-color: #3498db; }
        .btn-cancel { background-color: #e74c3c; }
        .notification { position: fixed; top: 20px; right: 20px; padding: 10px 20px; border-radius: 4px; 
                      color: white; font-weight: bold; z-index: 1000; }
        .success-notification { background-color: #2ecc71; }
        .error-notification { background-color: #e74c3c; }
        .saving-notification { background-color: #3498db; }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            z-index: 9999;
            overflow: auto;
        }
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        .modal-close {
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #333;
        }
        .modal-close:hover {
            color: #f00;
        }
        .preview-content {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 70vh;
            overflow-y: auto;
        }
        
        /* マークダウンプレビューのスタイル */
        .preview-content h1, .preview-content h2, .preview-content h3 { margin-top: 0.5em; margin-bottom: 0.5em; }
        .preview-content ul, .preview-content ol { padding-left: 2em; }
        .preview-content p { margin: 0.5em 0; }
        .preview-content code { background-color: #f1f1f1; padding: 2px 4px; border-radius: 3px; }
        .preview-content pre { background-color: #f5f5f5; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .article-meta { margin: 10px 0; color: #666; font-size: 0.9em; }
        .article-tags { margin: 10px 0; }
        .tag { background-color: #e0e0e0; padding: 2px 8px; border-radius: 12px; font-size: 0.8em; margin-right: 5px; }
    </style>
</head>
<body>
    <header class="header">
        <h1 id="editor-title">記事作成</h1>
        <a href="index.html">トップに戻る</a>
    </header>

    <main>
        <div class="form-group">
            <label for="article-title">タイトル:</label>
            <input type="text" id="article-title" placeholder="記事のタイトルを入力">
        </div>
        <div class="form-group">
            <label for="article-category">カテゴリ:</label>
            <input type="text" id="article-category" placeholder="カテゴリを入力">
        </div>
        <div class="form-group">
            <label for="article-tags">タグ:</label>
            <input type="text" id="article-tags" placeholder="カンマ区切りでタグを入力">
        </div>
        <div class="form-group">
            <label for="markdown-editor">マークダウンエディタ:</label>
            <textarea id="markdown-editor" placeholder="マークダウン形式で記事を入力してください..." rows="20"></textarea>
        </div>

        <div class="actions">
            <button id="save-article" class="btn btn-save" onclick="console.log('保存ボタンのonclickが発火'); if(typeof saveArticle === 'function') { saveArticle(); } else { console.error('saveArticle関数が見つかりません'); }">保存</button>
            <button id="preview-article" class="btn btn-preview" onclick="console.log('プレビューボタンのonclickが発火'); if(typeof previewArticle === 'function') { previewArticle(); } else { console.error('previewArticle関数が見つかりません'); }">プレビュー</button>
            <button id="export-article" class="btn btn-export" onclick="console.log('エクスポートボタンのonclickが発火');">エクスポート</button>
            <button id="cancel-editing" class="btn btn-cancel" onclick="console.log('キャンセルボタンのonclickが発火'); if(typeof cancelEditor === 'function') { cancelEditor(); } else { console.error('cancelEditor関数が見つかりません'); }">キャンセル</button>
        </div>
        
        <!-- デバッグ情報 -->
        <div id="debug-info" style="margin-top: 30px; border: 1px solid #ddd; padding: 15px; background: #f9f9f9;">
            <h3>デバッグ情報</h3>
            <button onclick="document.getElementById('debug-info').style.display = document.getElementById('debug-info').style.display === 'none' ? 'block' : 'none'">表示/非表示</button>
            <div>
                <p><strong>関数の存在:</strong></p>
                <ul>
                    <li>saveArticle: <span id="debug-save"></span></li>
                    <li>previewArticle: <span id="debug-preview"></span></li>
                    <li>cancelEditor: <span id="debug-cancel"></span></li>
                    <li>KB.editor: <span id="debug-kb-editor"></span></li>
                </ul>
                <p><strong>機能テスト:</strong></p>
                <button onclick="testSaveArticle()">保存テスト</button>
                <button onclick="testPreviewArticle()">プレビューテスト</button>
                <button onclick="testNotification()">通知テスト</button>
                <button onclick="testIndexedDB()">IndexedDBテスト</button>

                <p><strong>依存関係:</strong></p>
                <ul>
                    <li>schema: <span id="debug-schema"></span></li>
                    <li>converter: <span id="debug-converter"></span></li>
                    <li>database: <span id="debug-db"></span></li>
                </ul>
                <p><strong>エラー:</strong></p>
                <div id="debug-errors" style="color: red;"></div>
                <button onclick="updateDebugInfo()">更新</button>
                <div id="debug-log" style="margin-top: 10px; border: 1px solid #ccc; padding: 5px; max-height: 200px; overflow-y: auto; font-family: monospace; font-size: 12px;"></div>
            </div>
            <p><a href="debug/dbtest.html" target="_blank" style="display: inline-block; margin-top: 10px; padding: 5px 10px; background-color: #4CAF50; color: white; text-decoration: none; border-radius: 4px;">DBテストページを開く</a></p>
        </div>

        <!-- 直接実行用ボタン -->
        <div style="margin-top: 10px; padding: 10px; border: 1px solid #ccc; background-color: #f8f8f8;">
            <p><strong>直接実行テスト</strong></p>
            <button onclick="testDirectPreview()">直接プレビュー</button>
            <button onclick="testDirectSave()">直接保存</button>
            <button onclick="testDirectModalDisplay()">モーダル表示</button>
            <button onclick="testDirectDB()">直接DB保存</button>
            <button onclick="testDirectNotification()">通知表示</button>
        </div>
    </main>

    <!-- プレビューモーダル (改良版) -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closePreviewModal()">&times;</span>
            <h2>プレビュー</h2>
            <div id="preview-content" class="preview-content"></div>
            <div style="margin-top: 15px; text-align: right;">
                <button class="btn btn-cancel" onclick="closePreviewModal()">閉じる</button>
            </div>
        </div>
    </div>

    <!-- すべての必要なJSファイル -->
    <!-- 依存関係の明確化のため、読み込み順序を最適化 -->
    <!-- 1. コア機能 -->
    <script src="js/core/schema.js" defer></script>
    <script src="js/core/database.js" defer></script>
    <script src="js/core/converter.js" defer></script>
    
    <!-- 2. ユーティリティ -->
    <script src="js/util/jsonHelper.js" defer></script>
    <script src="js/util/sharedStatus.js" defer></script>
    <script src="js/util/storage.js" defer></script>
    
    <!-- 3. APIとUI -->
    <script src="js/core/api.js" defer></script>
    
    <!-- テスト用記事初期化スクリプト -->
    <script src="test-article.js" defer></script>
    
    <!-- 4. インライン化したエディタUII -->
    <script>
        // 名前空間と状態
        window.KB = window.KB || {};
        window.KB.editor = window.KB.editor || {
          article: null,
          currentArticle: null,
          editMode: false,
          originalContent: '', // 編集前のコンテンツを保存するためのプロパティ
          dependencies: { schema: false, converter: false, database: false }
        };

        // 変数のローカル参照
        const KB = window.KB;

        // 記事リセット
        function resetArticle() {
          KB.editor.article = {
            id: 'article_' + Date.now(),
            title: '',
            category: '',
            author: '',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString(),
            tags: [],
            content: '' // マークダウン形式のテキストとして保存
          };
        }

        // イベントリスナー設定
        function setupEventListeners() {
          // 基本フォーム
          const els = {
            title: document.getElementById('article-title'),
            category: document.getElementById('article-category'),
            tags: document.getElementById('article-tags'),
            editor: document.getElementById('markdown-editor'),
            saveBtn: document.getElementById('save-article'),
            previewBtn: document.getElementById('preview-article'),
            cancelBtn: document.getElementById('cancel-editing'),
            modal: document.getElementById('preview-modal')
          };
          
          els.title?.addEventListener('input', e => KB.editor.article && (KB.editor.article.title = e.target.value));
          els.category?.addEventListener('input', e => KB.editor.article && (KB.editor.article.category = e.target.value));
          els.tags?.addEventListener('input', e => KB.editor.article && setTags(e.target.value));
          
          els.editor?.addEventListener('input', e => KB.editor.article && (KB.editor.article.content = e.target.value));
          
          // モーダル
          if (els.modal) {
            document.querySelectorAll(`#preview-modal .modal-close`).forEach(btn => {
              btn.addEventListener('click', () => els.modal.style.display = 'none');
            });
            
            window.addEventListener('click', e => {
              if (e.target === els.modal) els.modal.style.display = 'none';
            });
          }
          
          // ブラウザ終了時
          window.addEventListener('beforeunload', (e) => {
            if (KB.editor.hasUnsavedChanges()) {
              e.preventDefault();
              e.returnValue = '変更内容が保存されていません。このページを離れますか？';
              
              const currentArticle = KB.editor.currentArticle;
              if (currentArticle?.id) {
                KB.shared?.unlock(currentArticle.id);
                KB.shared?.stopInterval(currentArticle.id);
              }
              
              return e.returnValue;
            }
          });
          
          // 基本的なショートカットキー
          els.editor?.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key.toLowerCase() === 's') {
              e.preventDefault();
              if (KB.editor && typeof KB.editor.saveArticle === 'function') {
                KB.editor.saveArticle();
              } else {
                console.error('ショートカットキー（Ctrl+S）: saveArticle関数が利用できません');
              }
            }
          });
        }

        // 最後の記事復元
        async function restoreLastArticle() {
          try {
            const lastId = localStorage.getItem('lastArticleId');
            if (lastId) {
              let saved = null;
              
              // 1. API経由で取得を試みる
              if (KB.articles && typeof KB.articles.get === 'function') {
                try {
                  saved = await KB.articles.get(lastId);
                  console.log('KB.articles.getから記事を復元:', saved?.id);
                } catch (e) {
                  console.warn('KB.articles.getからの読み込みに失敗:', e);
                }
              }
              
              // 2. window.DBから取得を試みる
              if (!saved && window.DB && typeof window.DB.get === 'function') {
                try {
                  saved = await window.DB.get(lastId);
                  console.log('window.DB.getから記事を復元:', saved?.id);
                } catch (e) {
                  console.warn('DB.getからの読み込みに失敗:', e);
                }
              }
              
              // 3. IndexedDBから直接取得を試みる
              if (!saved) {
                try {
                  saved = await getFromIndexedDB(lastId);
                  console.log('IndexedDBから記事を復元:', saved?.id);
                } catch (e) {
                  console.warn('IndexedDBからの読み込みに失敗:', e);
                }
              }
              
              // 4. LocalStorageから取得を試みる
              if (!saved) {
                const storedArticle = localStorage.getItem('kb_article_' + lastId);
                if (storedArticle) {
                  try {
                    saved = JSON.parse(storedArticle);
                    console.log('LocalStorageから記事を復元:', saved?.id);
                  } catch (e) {
                    console.warn('LocalStorageからの復元に失敗:', e);
                  }
                }
              }
              
              if (saved) {
                setupEditor(saved, false);
                if (KB.shared && typeof KB.shared.checkAndLock === 'function') {
                  KB.shared.checkAndLock(lastId);
                }
              } else {
                console.warn('記事が見つかりませんでした:', lastId);
              }
            }
          } catch (error) {
            console.error('記事復元エラー:', error);
          }
        }

        // IndexedDBから記事を取得
        function getFromIndexedDB(id) {
          return new Promise((resolve, reject) => {
            const dbName = 'KnowledgeBaseDB';
            const request = indexedDB.open(dbName, 1);
            
            request.onerror = (event) => {
              console.error('IndexedDBオープンエラー:', event);
              reject(new Error('データベースに接続できませんでした'));
            };
            
            request.onupgradeneeded = (event) => {
              const db = event.target.result;
              if (!db.objectStoreNames.contains('articles')) {
                db.createObjectStore('articles', { keyPath: 'id' });
              }
            };
            
            request.onsuccess = (event) => {
              const db = event.target.result;
              
              try {
                const transaction = db.transaction(['articles'], 'readonly');
                const store = transaction.objectStore('articles');
                
                const getRequest = store.get(id);
                
                getRequest.onerror = (event) => {
                  console.error('記事取得エラー:', event);
                  reject(new Error('記事の取得に失敗しました'));
                };
                
                getRequest.onsuccess = (event) => {
                  const result = event.target.result;
                  if (result) {
                    resolve(result);
                  } else {
                    reject(new Error('記事が見つかりませんでした'));
                  }
                };
                
                transaction.oncomplete = () => {
                  db.close();
                };
              } catch (error) {
                console.error('トランザクションエラー:', error);
                reject(error);
              }
            };
          });
        }

        // ブロック配列をマークダウンに変換（高速化版）
        function convertBlocksToMarkdown(blocks) {
          if (!Array.isArray(blocks) || blocks.length === 0) return '';
          
          // 直接文字列結合を使用
          let result = '';
          
          for (let i = 0; i < blocks.length; i++) {
            const block = blocks[i];
            if (!block || !block.type) continue;
            
            // ブロックタイプごとに処理
            switch (block.type) {
              case 'heading':
                result += '#'.repeat(block.level || 2) + ' ' + (block.text || '');
                break;
              case 'paragraph':
                result += block.text || '';
                break;
              case 'image':
                result += `![${block.alt || block.caption || ''}](${block.src || ''})`;
                if (block.caption) result += '\n' + block.caption;
                break;
              case 'list':
                if (!block.items || !Array.isArray(block.items) || block.items.length === 0) continue;
                for (let j = 0; j < block.items.length; j++) {
                  result += block.style === 'ordered' ? `${j + 1}. ${block.items[j]}` : `* ${block.items[j]}`;
                  if (j < block.items.length - 1) result += '\n';
                }
                break;
              default:
                continue;
            }
            
            // 各ブロック間の改行
            if (i < blocks.length - 1) result += '\n\n';
          }
          
          return result;
        }

        // マークダウンをHTMLに変換（プレビュー用）- 高速化版
        function markdownToHtml(markdown) {
          if (!markdown) return '';
          
          // 見出し、コード、リスト、リンク、画像などの基本的なマークダウン要素を変換
          let html = markdown
            // エスケープ処理
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            
            // 見出し
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            
            // コードブロック
            .replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            
            // リスト
            .replace(/^\* (.+)$/gm, '<li>$1</li>')
            .replace(/^(\d+)\. (.+)$/gm, '<li>$2</li>')
            
            // 強調
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/_([^_]+)_/g, '<em>$1</em>')
            
            // リンクと画像
            .replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
            .replace(/!\[([^\]]*)\]\(([^)]+)\)/g, '<img src="$2" alt="$1">');
          
          // リスト要素をリストタグでグループ化
          let lines = html.split('\n');
          let result = [];
          let inOrderedList = false;
          let inUnorderedList = false;
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i];
            const nextLine = i < lines.length - 1 ? lines[i+1] : '';
            
            if (line.startsWith('<li>') && line.endsWith('</li>')) {
              // リスト開始
              if (!inOrderedList && !inUnorderedList) {
                const isOrdered = /^(\d+)\. /.test(markdown.split('\n')[i] || '');
                result.push(isOrdered ? '<ol>' : '<ul>');
                inOrderedList = isOrdered;
                inUnorderedList = !isOrdered;
              }
              
              result.push(line);
              
              // リスト終了
              if (!nextLine.startsWith('<li>')) {
                result.push(inOrderedList ? '</ol>' : '</ul>');
                inOrderedList = false;
                inUnorderedList = false;
              }
            } else if (line.trim() && !line.startsWith('<h') && !line.startsWith('<pre>') && !line.startsWith('<img')) {
              // 通常の段落
              if (!line.startsWith('<')) {
                result.push(`<p>${line}</p>`);
              } else {
                result.push(line);
              }
            } else {
              result.push(line);
            }
          }
          
          return result.join('\n');
        }

        // 現在のフォームから記事情報を更新
        function updateArticleFromForm() {
          if (!KB.editor.article) return false;
          
          const article = KB.editor.article;
          
          const titleEl = document.getElementById('article-title');
          const categoryEl = document.getElementById('article-category');
          const tagsEl = document.getElementById('article-tags');
          const editorEl = document.getElementById('markdown-editor');
          
          if (titleEl) article.title = titleEl.value || '';
          if (categoryEl) article.category = categoryEl.value || '';
          if (tagsEl) setTags(tagsEl.value);
          if (editorEl) article.content = editorEl.value || '';
          
          article.updatedAt = new Date().toISOString();
          
          return true;
        }

        // タグを設定
        function setTags(tagsStr) {
          if (!KB.editor.article || !tagsStr) return;
          
          const tagsArray = tagsStr.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
          KB.editor.article.tags = tagsArray;
        }

        // 記事が変更されたかどうか確認
        function hasUnsavedChanges() {
          if (!KB.editor.article) return false;
          
          const article = KB.editor.article;
          const originalContent = KB.editor.originalContent || '';
          
          const titleEl = document.getElementById('article-title');
          const categoryEl = document.getElementById('article-category');
          const contentEl = document.getElementById('markdown-editor');
          const tagsEl = document.getElementById('article-tags');
          
          if (
            (titleEl && titleEl.value !== (article.title || '')) ||
            (categoryEl && categoryEl.value !== (article.category || '')) ||
            (contentEl && contentEl.value !== originalContent)
          ) {
            return true;
          }
          
          if (tagsEl) {
            const currentTags = tagsEl.value.split(',').map(t => t.trim()).filter(Boolean);
            const originalTags = article.tags || [];
            
            if (currentTags.length !== originalTags.length) return true;
            
            const originalTagSet = new Set(originalTags);
            for (let i = 0; i < currentTags.length; i++) {
              if (!originalTagSet.has(currentTags[i])) return true;
            }
          }
          
          return false;
        }

        // 記事保存
        async function saveArticle() {
          if (!KB.editor.article) return false;
          
          try {
            if (!updateArticleFromForm()) return false;
            
            const article = KB.editor.article;
            const isNew = !KB.editor.currentArticle;
            
            showNotification('saving', '保存中...');
            
            let saved = null; // nullで初期化
            let saveError = null; // エラー情報を保持する変数

            // 1. KB.articles.save 経由
            if (KB.articles && KB.articles.save) {
              try {
                console.log("KB.articles.saveで保存を試みます");
                saved = await KB.articles.save(article, isNew);
                // KB.articles.saveがundefinedを返す場合、articleをsavedに設定
                if (saved === undefined && article) {
                  saved = article;
                  console.log("KB.articles.saveがundefinedを返したため、元の記事オブジェクトを使用します");
                }
                console.log("KB.articles.saveの結果:", saved);
              } catch (e) {
                saveError = e;
                console.error("KB.articles.saveでのエラー:", e);
              }
            }

            // 2. window.DB.save 経由 (まだ保存されていない場合)
            if (!saved && window.DB && typeof window.DB.save === 'function') {
              try {
                console.log("window.DB.saveで保存を試みます");
                // window.DB.saveは値を返さないことが多いので、成功したらarticleをsavedに設定
                await window.DB.save(article);
                saved = article; // 保存が成功したとみなし、元のarticleを使う
                console.log("window.DB.saveでの保存が成功しました、元の記事オブジェクトを使用します");
              } catch (e) {
                saveError = e;
                console.error("window.DB.saveでのエラー:", e);
              }
            }

            // 3. IndexedDB直接保存 (まだ保存されていない場合)
            if (!saved) {
              try {
                console.log("saveDirectToIndexedDBAsyncで保存を試みます");
                saved = await saveDirectToIndexedDBAsync(article);
                // saveDirectToIndexedDBAsyncがundefinedを返す場合、articleをsavedに設定
                if (saved === undefined && article) {
                  saved = article;
                  console.log("saveDirectToIndexedDBAsyncがundefinedを返したため、元の記事オブジェクトを使用します");
                }
                console.log("saveDirectToIndexedDBAsyncの結果:", saved);
              } catch (e) {
                saveError = e;
                console.error("saveDirectToIndexedDBAsyncでのエラー:", e);
              }
            }

            // 4. LocalStorage フォールバック (まだ保存されていない場合)
            if (!saved && article && article.id) { // articleとarticle.idが存在する場合のみ試行
              try {
                console.warn("すべての主要な保存方法が失敗または利用不可です。LocalStorageにフォールバックします");
                localStorage.setItem('kb_article_' + article.id, JSON.stringify(article));
                saved = article; // LocalStorageに保存できたら、元のarticleを使う
                console.log('LocalStorageへのフォールバック保存が成功:', saved);
                saveError = null; // LocalStorageへの保存が成功したのでエラーは無視
              } catch (lsError) {
                saveError = lsError; // LocalStorageも失敗した場合のエラーを設定
                console.error('LocalStorage保存エラー:', lsError);
              }
            }

            // 最終チェック
            // saved が存在し、かつ saved.id が存在するかを確認
            if (saved && typeof saved.id !== 'undefined') {
              console.log("保存成功。最終的な'saved'オブジェクト:", saved);
              // 成功時の処理
              KB.editor.currentArticle = saved.id; // 互換性のためIDのみを保存
              KB.editor.originalContent = saved.content || ''; // savedから取得
              
              // 最後に編集した記事のIDを保存
              try {
                localStorage.setItem('lastArticleId', saved.id); // IDの存在を確認済み
              } catch (lsError) {
                console.warn('lastArticleIdの保存に失敗しましたが、記事自体は保存されています:', lsError);
              }
              
              // 保存完了通知
              showNotification('success', '記事を保存しました');
              return true; // 成功
            } else {
              // すべての保存方法が失敗したか、有効な saved が得られなかった
              console.error('すべての方法で記事の保存に失敗しました。最後のエラー:', saveError);
              showNotification('error', `保存に失敗しました: ${saveError ? saveError.message : '不明なエラー'}`);
              return false; // 失敗
            }
          } catch (error) { // このcatchは予期せぬエラー用
            console.error('記事保存処理の途中で予期せぬエラー:', error);
            showNotification('error', `保存エラー: ${error.message || '不明なエラー'}`);
            return false;
          }
        }

        // IndexedDBに直接保存（Promise版）
        function saveDirectToIndexedDBAsync(article) {
          return new Promise((resolve, reject) => {
            if (!article || !article.id) {
              reject(new Error('記事オブジェクトまたはIDが未定義です'));
              return;
            }
            
            const request = indexedDB.open('knowledgeBase', 1);
            
            request.onerror = function(event) {
              console.error('IndexedDBオープンエラー:', event.target.error);
              reject(new Error('IndexedDBに接続できませんでした: ' + (event.target.error ? event.target.error.message : '不明なエラー')));
            };
            
            request.onupgradeneeded = function(event) {
              const db = event.target.result;
              if (!db.objectStoreNames.contains('articles')) {
                db.createObjectStore('articles', { keyPath: 'id' });
              }
            };
            
            request.onsuccess = function(event) {
              const db = event.target.result;
              
              try {
                const transaction = db.transaction(['articles'], 'readwrite');
                const store = transaction.objectStore('articles');
                
                const saveRequest = store.put(article);
                
                saveRequest.onsuccess = function() {
                  console.log('直接IndexedDBへの保存成功:', article.id);
                  resolve(article);
                };
                
                saveRequest.onerror = function(event) {
                  console.error('直接IndexedDBへの保存エラー:', event.target.error);
                  reject(new Error('記事の保存に失敗しました: ' + (event.target.error ? event.target.error.message : '不明なエラー')));
                };
                
                transaction.oncomplete = function() {
                  db.close();
                };
                
                transaction.onerror = function(event) {
                  console.error('トランザクションエラー:', event.target.error);
                  reject(new Error('トランザクションエラー: ' + (event.target.error ? event.target.error.message : '不明なエラー')));
                };
              } catch (error) {
                console.error('IndexedDB操作エラー:', error);
                db.close();
                reject(error);
              }
            };
          });
        }

        // データベースへの保存処理を分離
        function saveArticleToDatabase(article) {
          if (!article || !article.id) {
            console.error('無効な記事データです');
            alert('無効な記事データです');
            return;
          }
          
          try {
            // KB.database経由で保存
            if (window.KB && window.KB.database && typeof window.KB.database.saveArticle === 'function') {
              console.log('KB.database.saveArticle を使用して保存します');
              
              window.KB.database.saveArticle(article)
                .then(result => {
                  console.log('IndexedDBへの保存成功:', result);
                  showNotification('success', '記事が保存されました');
                })
                .catch(error => {
                  console.error('IndexedDBへの保存エラー:', error);
                  
                  // LocalStorageへのフォールバック
                  try {
                    localStorage.setItem('article_' + article.id, JSON.stringify(article));
                    console.log('LocalStorageへの保存成功');
                    showNotification('info', '記事がLocalStorageに保存されました');
                  } catch (e) {
                    console.error('LocalStorageへの保存エラー:', e);
                    alert('保存に失敗しました: ' + e.message);
                  }
                });
            } 
            // window.DB経由で保存
            else if (window.DB && typeof window.DB.save === 'function') {
              console.log('window.DB.save を使用して保存します');
              
              window.DB.save(article)
                .then(result => {
                  console.log('IndexedDBへの保存成功:', result);
                  showNotification('success', '記事が保存されました');
                })
                .catch(error => {
                  console.error('IndexedDBへの保存エラー:', error);
                  saveToLocalStorage(article);
                });
            }
            // 直接IndexedDBを使用して保存
            else {
              console.log('直接IndexedDBを使用して保存します');
              saveDirectToIndexedDB(article);
            }
          } catch (error) {
            console.error('保存処理エラー:', error);
            saveToLocalStorage(article);
          }
        }

        // LocalStorageに保存
        function saveToLocalStorage(article) {
          try {
            localStorage.setItem('article_' + article.id, JSON.stringify(article));
            console.log('LocalStorageへの保存成功');
            showNotification('info', '記事がLocalStorageに保存されました');
          } catch (e) {
            console.error('LocalStorageへの保存エラー:', e);
            alert('すべての保存方法が失敗しました: ' + e.message);
          }
        }

        // 記事プレビュー
        function previewArticle() {
          if (!KB.editor.article) {
            console.error('KB.editor.article が見つかりません');
            alert('記事データがありません');
            return;
          }
          
          console.log('プレビュー開始: ', KB.editor.article);
          updateArticleFromForm();
          
          const article = KB.editor.article;
          const modal = document.getElementById('preview-modal');
          const content = document.getElementById('preview-content');
          
          if (!modal || !content) {
            console.error('プレビューモーダルまたはコンテンツエレメントが見つかりません');
            alert('プレビューモーダルがDOMに存在しません');
            return;
          }
          
          try {
            // HTMLを組み立て
            let html = `
              <h1>${article.title || '(無題)'}</h1>
              <div class="article-meta">
                <span>カテゴリ: ${article.category || 'なし'}</span>
                <span>更新: ${new Date(article.updatedAt).toLocaleString()}</span>
              </div>
            `;
            
            if (article.tags && article.tags.length > 0) {
              html += '<div class="article-tags">';
              for (let i = 0; i < article.tags.length; i++) {
                html += `<span class="tag">${article.tags[i]}</span>` + (i < article.tags.length - 1 ? ' ' : '');
              }
              html += '</div>';
            }
            
            html += '<div class="article-content">';
            
            if (typeof article.content === 'string') {
              html += markdownToHtml(article.content);
            } else if (Array.isArray(article.content)) {
              html += markdownToHtml(convertBlocksToMarkdown(article.content));
            }
            
            html += '</div>';
            
            content.innerHTML = html;
            modal.style.display = 'block';
            console.log('プレビューを表示しました');
          } catch (error) {
            console.error('プレビュー表示エラー:', error);
            alert('プレビュー表示中にエラーが発生しました: ' + error.message);
          }
        }

        // エディターキャンセル
        function cancelEditor() {
          if (hasUnsavedChanges() && !confirm('変更内容が保存されていません。編集をキャンセルしますか？')) {
            return;
          }
          
          if (KB.editor.currentArticle?.id) {
            KB.shared?.unlock(KB.editor.currentArticle.id);
            KB.shared?.stopInterval(KB.editor.currentArticle.id);
          }
          
          window.location.href = 'index.html';
        }

        // 通知を表示
        function showNotification(type, message) {
          // 新しい形式の通知関数を呼び出し
          let messageType = 'info';
          
          if (type === 'error') messageType = 'error';
          else if (type === 'success') messageType = 'success';
          else if (type === 'saving') messageType = 'info';
          
          return window.showMsgNotification(message, messageType);
        }

        // エディタセットアップ
        function setupEditor(article, isNew = false) {
          if (!article) return false;
          
          KB.editor.article = article;
          KB.editor.currentArticle = isNew ? null : article;
          
          const titleEl = document.getElementById('article-title');
          const categoryEl = document.getElementById('article-category');
          const tagsEl = document.getElementById('article-tags');
          const markdownEditor = document.getElementById('markdown-editor');
          
          if (titleEl) titleEl.value = article.title || '';
          if (categoryEl) categoryEl.value = article.category || '';
          
          if (tagsEl && article.tags && Array.isArray(article.tags)) {
            tagsEl.value = article.tags.join(', ');
          }
          
          if (markdownEditor) {
            let markdownContent = '';
            
            if (Array.isArray(article.content)) {
              markdownContent = convertBlocksToMarkdown(article.content);
              KB.editor.article.content = markdownContent;
            } else if (typeof article.content === 'string') {
              markdownContent = article.content;
            }
            
            markdownEditor.value = markdownContent;
            KB.editor.originalContent = markdownContent;
          }
          
          return true;
        }

        // 初期化
        function initApp() {
          console.log('KB.editor 関数初期化開始');
          
          // 公開関数の設定
          KB.editor.setupEditor = setupEditor;
          KB.editor.updateArticleFromForm = updateArticleFromForm;
          KB.editor.hasUnsavedChanges = hasUnsavedChanges;
          KB.editor.markdownToHtml = markdownToHtml;
          KB.editor.htmlToMarkdown = convertBlocksToMarkdown;
          KB.editor.saveArticle = saveArticle;
          KB.editor.previewArticle = previewArticle;
          KB.editor.cancelEditor = cancelEditor;
          
          console.log('KB.editor 関数初期化完了。公開関数:', 
            Object.keys(KB.editor).filter(key => typeof KB.editor[key] === 'function').join(', '));
          
          // 自動保存の設定
          const textarea = document.getElementById('markdown-editor');
          if (textarea) {
            let saveTimeout;
            textarea.addEventListener('input', () => {
              clearTimeout(saveTimeout);
              saveTimeout = setTimeout(() => {
                if (KB.editor.hasUnsavedChanges()) saveArticle();
              }, 2000);
            });
          }
        }
        
        // ページ読み込み時にデバッグ情報を更新
        document.addEventListener('DOMContentLoaded', function() {
          try {
            // エディタ初期化
            initApp();
            
            // デバッグ情報を表示
            updateDebugInfo();
            logDebug('エディタページが初期化されました');
            
            // テスト用の記事データをセット
            if (!window.KB) window.KB = {};
            if (!window.KB.editor) window.KB.editor = {};
            window.KB.editor.article = {
              id: 'test_init_' + Date.now(),
              title: 'テスト記事',
              category: 'テスト',
              tags: ['テスト', 'デバッグ'],
              content: '# テスト記事\n\nこのテスト記事は自動的に作成されました。\n\n* リスト項目1\n* リスト項目2\n\n```\nコードブロック\n```',
              createdAt: new Date().toISOString(),
              updatedAt: new Date().toISOString()
            };
            
            // エディタフィールドにデータをセット
            document.getElementById('article-title').value = window.KB.editor.article.title;
            document.getElementById('article-category').value = window.KB.editor.article.category;
            document.getElementById('article-tags').value = window.KB.editor.article.tags.join(', ');
            document.getElementById('article-content').value = window.KB.editor.article.content;
            
            logDebug('テスト記事データをセットしました');
          } catch (e) {
            console.error('初期化エラー:', e);
            if (typeof logDebug === 'function') {
              logDebug('初期化エラー: ' + e.message);
            }
          }
        });

        // 関数をグローバルスコープに公開
        window.saveArticle = saveArticle;
        window.previewArticle = previewArticle;
        window.cancelEditor = cancelEditor;
        window.showNotification = showNotification;
        window.setupEditor = setupEditor;
        window.updateArticleFromForm = updateArticleFromForm;
        window.setTags = setTags;
        window.hasUnsavedChanges = hasUnsavedChanges;
        window.markdownToHtml = markdownToHtml;
        window.convertBlocksToMarkdown = convertBlocksToMarkdown;
        window.saveToIndexedDB = saveToIndexedDB;
        window.getFromIndexedDB = getFromIndexedDB;
    </script>
    
    <script>
        // 初期化エラー報告用関数
        function reportInitError(moduleName, error) {
            console.error(`${moduleName}初期化エラー:`, error);
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-notification';
            errorDiv.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);' +
                'background-color:#f44336;color:white;padding:20px;border-radius:5px;z-index:1000;' +
                'box-shadow:0 0 10px rgba(0,0,0,0.5);max-width:80%;text-align:center;';
            
            errorDiv.innerHTML = `
                <h3>初期化エラー: ${moduleName}</h3>
                <p>${error.message || '不明なエラー'}</p>
                <p>詳細はコンソールを確認してください</p>
                <button onclick="this.parentNode.remove()" style="background:#fff;color:#f44336;border:none;padding:8px 15px;border-radius:3px;cursor:pointer;margin-top:10px;">閉じる</button>
            `;
            document.body.appendChild(errorDiv);
        }
    </script>

    <script>
    // デバッグ情報の更新
    function updateDebugInfo() {
      try {
        // 関数の存在をチェック
        document.getElementById('debug-save').textContent = typeof saveArticle === 'function' ? '存在します' : '存在しません';
        document.getElementById('debug-preview').textContent = typeof previewArticle === 'function' ? '存在します' : '存在しません';
        document.getElementById('debug-cancel').textContent = typeof cancelEditor === 'function' ? '存在します' : '存在しません';
        
        // window.KB名前空間のチェック
        document.getElementById('debug-kb-editor').textContent = window.KB && window.KB.editor ? '存在します' : '存在しません';
        document.getElementById('debug-schema').textContent = window.KB && window.KB.schema ? '読み込み済み' : '未読み込み';
        document.getElementById('debug-converter').textContent = window.KB && window.KB.converter ? '読み込み済み' : '未読み込み';
        document.getElementById('debug-db').textContent = window.KB && window.KB.database ? '読み込み済み' : '未読み込み';
        
        // データベース関数のチェック
        const dbFunctions = window.KB && window.KB.database 
          ? Object.keys(window.KB.database).join(', ') 
          : 'なし';
        
        // エラー表示をクリア
        document.getElementById('debug-errors').innerHTML = '';
        
        // ログに情報を追加
        logDebug('デバッグ情報を更新しました');
        logDebug('データベース関数: ' + dbFunctions);
        
        // window.KB.editor.article の内容を表示
        if (window.KB && window.KB.editor && window.KB.editor.article) {
          logDebug('現在の記事: ' + JSON.stringify(window.KB.editor.article, null, 2));
        } else {
          logDebug('記事データがありません');
        }
      } catch (e) {
        document.getElementById('debug-errors').innerHTML += `<p>デバッグ情報更新エラー: ${e.message}</p>`;
        console.error('デバッグ情報更新エラー:', e);
      }
    }

    // デバッグログ表示
    function logDebug(message) {
      try {
        const logElement = document.getElementById('debug-log');
        const timestamp = new Date().toLocaleTimeString();
        logElement.innerHTML += `<div>[${timestamp}] ${message}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
      } catch (e) {
        console.error('ログ表示エラー:', e);
      }
    }

    // 保存テスト関数
    function testSaveArticle() {
      logDebug('保存テスト開始');
      try {
        if (typeof saveArticle === 'function') {
          logDebug('saveArticle関数を実行します');
          saveArticle();
        } else {
          logDebug('saveArticle関数が見つかりません');
        }
      } catch (e) {
        logDebug(`保存テストエラー: ${e.message}`);
        document.getElementById('debug-errors').innerHTML += `<p>保存テストエラー: ${e.message}</p>`;
      }
    }

    // プレビューテスト関数
    function testPreviewArticle() {
      logDebug('プレビューテスト開始');
      try {
        if (typeof previewArticle === 'function') {
          logDebug('previewArticle関数を実行します');
          previewArticle();
        } else {
          logDebug('previewArticle関数が見つかりません');
        }
      } catch (e) {
        logDebug(`プレビューテストエラー: ${e.message}`);
        document.getElementById('debug-errors').innerHTML += `<p>プレビューテストエラー: ${e.message}</p>`;
      }
    }

    // 通知テスト関数
    function testNotification() {
      logDebug('通知テスト開始');
      try {
        const notification = document.createElement('div');
        notification.className = 'notification success-notification';
        notification.textContent = 'テスト通知';
        document.body.appendChild(notification);
        
        setTimeout(() => {
          notification.remove();
        }, 3000);
        
        logDebug('通知を表示しました');
      } catch (e) {
        logDebug(`通知テストエラー: ${e.message}`);
        document.getElementById('debug-errors').innerHTML += `<p>通知テストエラー: ${e.message}</p>`;
      }
    }

    // IndexedDBテスト関数
    function testIndexedDB() {
      logDebug('IndexedDBテスト開始');
      try {
        if (window.indexedDB) {
          logDebug('IndexedDBがサポートされています');
          
          const request = indexedDB.open('testDB', 1);
          
          request.onerror = function(event) {
            logDebug(`IndexedDBエラー: ${event.target.errorCode}`);
            document.getElementById('debug-errors').innerHTML += `<p>IndexedDBエラー: ${event.target.errorCode}</p>`;
          };
          
          request.onsuccess = function(event) {
            logDebug('IndexedDBに接続しました');
            const db = event.target.result;
            db.close();
          };
          
          request.onupgradeneeded = function(event) {
            logDebug('IndexedDBをアップグレードしています');
            const db = event.target.result;
            
            if (!db.objectStoreNames.contains('testStore')) {
              db.createObjectStore('testStore', { keyPath: 'id' });
              logDebug('テストストアを作成しました');
            }
          };
        } else {
          logDebug('IndexedDBはサポートされていません');
          document.getElementById('debug-errors').innerHTML += '<p>IndexedDBはサポートされていません</p>';
        }
      } catch (e) {
        logDebug(`IndexedDBテストエラー: ${e.message}`);
        document.getElementById('debug-errors').innerHTML += `<p>IndexedDBテストエラー: ${e.message}</p>`;
      }
    }
    </script>

    <script>
    // プレビューモーダルを閉じる
    function closePreviewModal() {
        document.getElementById('preview-modal').style.display = 'none';
    }

    // プレビューモーダルを表示
    function showPreviewModal() {
        document.getElementById('preview-modal').style.display = 'block';
    }

    // プレビューモーダル外クリックでも閉じる
    window.addEventListener('click', function(event) {
        const modal = document.getElementById('preview-modal');
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
    </script>

    <script>
    // 直接プレビュー実行テスト
    function testDirectPreview() {
      console.log('直接プレビュー実行テスト開始');
      
      try {
        // テスト用の記事データを作成
        const testArticle = {
          id: 'test_direct_preview_' + Date.now(),
          title: '直接プレビューテスト',
          category: 'テスト',
          tags: ['テスト', 'プレビュー'],
          content: '# 直接プレビューテスト\n\nこれは直接実行テストです。\n\n* リスト項目1\n* リスト項目2\n\n```\nコードブロック\n```',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // 記事データをエディタにセット
        if (!window.KB) window.KB = {};
        if (!window.KB.editor) window.KB.editor = {};
        window.KB.editor.article = testArticle;
        
        // プレビュー用モーダルのエレメントを取得
        const modal = document.getElementById('preview-modal');
        const content = document.getElementById('preview-content');
        
        if (!modal || !content) {
          console.error('モーダルまたはコンテンツ要素が見つかりません');
          alert('プレビューモーダルがありません');
          return;
        }
        
        // マークダウンをHTMLに変換（簡易実装）
        function simpleMarkdownToHtml(markdown) {
          if (!markdown) return '';
          
          return markdown
            .replace(/^# (.+)$/gm, '<h1>$1</h1>')
            .replace(/^## (.+)$/gm, '<h2>$1</h2>')
            .replace(/^### (.+)$/gm, '<h3>$1</h3>')
            .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
            .replace(/_([^_]+)_/g, '<em>$1</em>')
            .replace(/`([^`]+)`/g, '<code>$1</code>')
            .replace(/```([^`]+)```/g, '<pre><code>$1</code></pre>')
            .replace(/^\* (.+)$/gm, '<li>$1</li>')
            .replace(/\n\n/g, '<br><br>');
        }
        
        // HTMLを組み立て
        let html = `
          <h1>${testArticle.title}</h1>
          <div class="article-meta">
            <span>カテゴリ: ${testArticle.category}</span>
            <span>更新: ${new Date(testArticle.updatedAt).toLocaleString()}</span>
          </div>
          <div class="article-tags">
            ${testArticle.tags.map(tag => `<span class="tag">${tag}</span>`).join(' ')}
          </div>
          <div class="article-content">
            ${simpleMarkdownToHtml(testArticle.content)}
          </div>
        `;
        
        // コンテンツをセットしてモーダルを表示
        content.innerHTML = html;
        modal.style.display = 'block';
        console.log('プレビューモーダルを表示しました');
      } catch (error) {
        console.error('直接プレビュー実行エラー:', error);
        alert('プレビュー実行エラー: ' + error.message);
      }
    }
    </script>

    <script>
    // 直接保存機能テスト
    function testDirectSave() {
      console.log('直接保存テスト開始');
      
      try {
        // 各入力要素からデータを直接取得
        const titleInput = document.getElementById('article-title');
        const categoryInput = document.getElementById('article-category');
        const tagsInput = document.getElementById('article-tags');
        const contentInput = document.getElementById('markdown-editor') || document.getElementById('article-content');
        
        if (!titleInput || !categoryInput || !tagsInput || !contentInput) {
          console.error('入力要素が見つかりません', {
            titleInput: !!titleInput, 
            categoryInput: !!categoryInput, 
            tagsInput: !!tagsInput, 
            contentInput: !!contentInput
          });
          alert('入力要素が見つかりません。強制的にテストデータを使用します。');
          
          // テストデータを直接使用
          const testArticle = {
            id: 'test_save_' + Date.now(),
            title: 'テストタイトル',
            category: 'テストカテゴリ',
            tags: ['テスト', 'タグ'],
            content: '# テスト内容\n\nこれはテスト内容です。',
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
          };
          
          console.log('テストデータを使用して保存します:', testArticle);
          saveArticleToDatabase(testArticle);
          return;
        }
        
        // 入力値を取得
        const title = titleInput.value || 'テストタイトル';
        const category = categoryInput.value || 'テストカテゴリ';
        const tagsText = tagsInput.value || 'テスト,タグ';
        const content = contentInput.value || '# テスト内容\n\nこれはテスト内容です。';
        
        // タグを配列に変換
        const tags = tagsText.split(',').map(tag => tag.trim()).filter(tag => tag);
        
        // 記事オブジェクトを作成
        const article = {
          id: 'test_save_' + Date.now(),
          title: title,
          category: category,
          tags: tags,
          content: content,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        console.log('保存する記事データ:', article);
        saveArticleToDatabase(article);
      } catch (error) {
        console.error('直接保存テストエラー:', error);
        alert('保存テストエラー: ' + error.message);
      }
    }

    // 直接IndexedDBに保存
    function saveDirectToIndexedDB(article) {
      const request = indexedDB.open('knowledgeBase', 1);
      
      request.onerror = function(event) {
        console.error('IndexedDBオープンエラー:', event.target.error);
        saveToLocalStorage(article);
      };
      
      request.onupgradeneeded = function(event) {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('articles')) {
          db.createObjectStore('articles', { keyPath: 'id' });
        }
      };
      
      request.onsuccess = function(event) {
        const db = event.target.result;
        const transaction = db.transaction(['articles'], 'readwrite');
        const store = transaction.objectStore('articles');
        
        const saveRequest = store.put(article);
        
        saveRequest.onsuccess = function() {
          console.log('直接IndexedDBへの保存成功');
          showNotification('success', '記事が保存されました');
        };
        
        saveRequest.onerror = function(event) {
          console.error('直接IndexedDBへの保存エラー:', event.target.error);
          saveToLocalStorage(article);
        };
        
        transaction.oncomplete = function() {
          db.close();
        };
      };
    }

    // LocalStorageに保存
    function saveToLocalStorage(article) {
      try {
        localStorage.setItem('article_' + article.id, JSON.stringify(article));
        console.log('LocalStorageへの保存成功');
        showNotification('info', '記事がLocalStorageに保存されました');
      } catch (e) {
        console.error('LocalStorageへの保存エラー:', e);
        alert('すべての保存方法が失敗しました: ' + e.message);
      }
    }
    </script>

    <script>
    // 直接モーダル表示テスト
    function testDirectModalDisplay() {
      console.log('直接モーダル表示');
      try {
        const modal = document.getElementById('preview-modal');
        if (modal) {
          modal.style.display = 'block';
          console.log('モーダルを表示しました');
        } else {
          console.error('プレビューモーダルが見つかりません');
          alert('プレビューモーダルが見つかりません');
        }
      } catch(e) {
        console.error('モーダル表示エラー:', e);
        alert('モーダル表示エラー: ' + e.message);
      }
    }

    // 直接DB保存テスト
    function testDirectDB() {
      console.log('直接IndexDB保存'); 
      try {
        const testData = {
          id: 'test_direct_' + Date.now(), 
          title: '直接保存テスト', 
          content: 'テスト内容',
          category: 'テスト',
          tags: ['テスト'],
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // 成功・失敗ハンドラ
        const onSuccess = (r) => {
          console.log('保存OK', r);
          showNotification('success', 'DB保存成功');
        };
        const onError = (e) => {
          console.error('保存エラー', e);
          showNotification('error', 'DB保存エラー: ' + e.message);
        };
        
        // 利用可能なDB関数を使用
        if (typeof saveDirectToIndexedDBAsync === 'function') {
          console.log('saveDirectToIndexedDBAsync関数を使用します');
          saveDirectToIndexedDBAsync(testData).then(onSuccess).catch(onError);
        } else if (window.saveToIndexedDB) {
          window.saveToIndexedDB(testData).then(onSuccess).catch(onError);
        } else if (window.KB && window.KB.database && window.KB.database.saveArticle) {
          window.KB.database.saveArticle(testData).then(onSuccess).catch(onError);
        } else if (window.DB && window.DB.save) {
          window.DB.save(testData).then(onSuccess).catch(onError);
        } else {
          throw new Error('利用可能なDB保存関数が見つかりません');
        }
      } catch(e) {
        console.error('DB保存テストエラー:', e);
        showNotification('error', 'DB保存テストエラー: ' + e.message);
      }
    }

    // 直接通知表示テスト
    function testDirectNotification() {
      console.log('直接通知表示');
      try {
        showNotification('success', 'テスト通知');
      } catch(e) {
        console.error('通知表示エラー:', e);
        alert('通知表示エラー: ' + e.message);
      }
    }

    // 通知表示統一関数
    window.showMsgNotification = function(message, type = 'info') {
      try {
        const notification = document.createElement('div');
        notification.className = `notification ${type}-notification`;
        notification.textContent = message;
        document.body.appendChild(notification);
        
        // 3秒後に自動的に消える
        setTimeout(() => {
          notification.remove();
        }, 3000);
        
        return notification;
      } catch (e) {
        console.error('通知表示エラー:', e);
        return null;
      }
    };
    </script>

    <script>
    // ロード完了時に初期化（window.onloadを使用）
    window.addEventListener('load', function() {
        console.log('editor.html: window.onload イベント発火');
        
        // 依存関係のチェック
        if (!window.KB) window.KB = {};
        if (!window.KB.editor) window.KB.editor = {};
        
        window.KB.editor.dependencies = {
          schema: window.articleSchema !== undefined,
          converter: window.Converter !== undefined,
          database: window.DB !== undefined
        };
        
        if (!KB.editor.dependencies.schema) {
          console.warn('必要なモジュールが読み込まれていません。一部機能が制限される可能性があります。');
        }
        
        console.log('KB.editor 初期化開始');
        
        // 初期化処理
        resetArticle();
        setupEventListeners();
        restoreLastArticle();
        initApp();
        
        console.log('KB.editor 初期化完了 - 公開関数:', 
          Object.keys(KB.editor).filter(key => typeof KB.editor[key] === 'function').join(', '));
        
        // 1秒後に初期化状態を再チェック
        setTimeout(() => {
          console.log('KB.editor 初期化状態確認:', 
            Object.keys(KB.editor).filter(key => typeof KB.editor[key] === 'function').join(', '));
        }, 1000);
        
        // ボタンイベントリスナーを追加
        const saveBtn = document.getElementById('save-article');
        if (saveBtn) {
          console.log('保存ボタンにイベントリスナーを追加');
          saveBtn.addEventListener('click', function() {
            console.log('保存ボタンがクリックされました');
            saveArticle();
          });
        } else {
          console.error('保存ボタンが見つかりません');
        }
        
        const previewBtn = document.getElementById('preview-article');
        if (previewBtn) {
          console.log('プレビューボタンにイベントリスナーを追加');
          previewBtn.addEventListener('click', function() {
            console.log('プレビューボタンがクリックされました');
            previewArticle();
          });
        }
        
        const exportBtn = document.getElementById('export-article');
        if (exportBtn) {
          console.log('エクスポートボタンにイベントリスナーを追加');
          exportBtn.addEventListener('click', function() {
            console.log('エクスポートボタンがクリックされました');
            if (KB.io && typeof KB.io.exportArticle === 'function') {
              KB.io.exportArticle(KB.editor.article);
            } else {
              showNotification('error', 'エクスポート機能が利用できません');
            }
          });
        }
        
        const cancelBtn = document.getElementById('cancel-editing');
        if (cancelBtn) {
          console.log('キャンセルボタンにイベントリスナーを追加');
          cancelBtn.addEventListener('click', function() {
            console.log('キャンセルボタンがクリックされました');
            cancelEditor();
          });
        }
        
        // デバッグ情報を表示
        if (typeof updateDebugInfo === 'function') {
          updateDebugInfo();
        }
        
        // テスト用の記事データをセット
        window.KB.editor.article = window.KB.editor.article || {
          id: 'test_init_' + Date.now(),
          title: 'テスト記事',
          category: 'テスト',
          tags: ['テスト', 'デバッグ'],
          content: '# テスト記事\n\nこのテスト記事は自動的に作成されました。\n\n* リスト項目1\n* リスト項目2\n\n```\nコードブロック\n```',
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString()
        };
        
        // エディタフィールドにデータをセット（既存データがなければ）
        if (!document.getElementById('article-title').value) {
          document.getElementById('article-title').value = window.KB.editor.article.title;
          document.getElementById('article-category').value = window.KB.editor.article.category;
          document.getElementById('article-tags').value = window.KB.editor.article.tags.join(', ');
          document.getElementById('article-content').value = window.KB.editor.article.content;
        }
        
        if (typeof logDebug === 'function') {
          logDebug('エディタの初期化とテストデータのセットアップが完了しました');
        }
    });
    </script>
</body>
</html> 