# editor.js ドキュメント

## 概要

editor.jsは、ナレッジベースアプリケーション用のマークダウンエディタを提供するJavaScriptファイルです。テキストエリアベースのシンプルなマークダウンエディタとして実装されており、記事の作成や編集において、ユーザーフレンドリーなインターフェースを提供します。

## 基本構造

エディタの基本構造は以下の通りです：

1. 名前空間 `KB.editor` - エディタの状態管理と公開関数を格納
2. 初期化処理 - 依存関係のチェックと基本設定
3. エディタUIコンポーネント - テキストエリアとツールバー
4. マークダウン処理機能 - マークダウンとHTMLの相互変換

## 状態管理

エディタは以下の状態変数を管理します：

- `article` - 現在編集中の記事データ
- `currentArticle` - サーバーから取得した元の記事データ（変更検出用）
- `editMode` - 編集モードフラグ
- `originalContent` - 編集前のコンテンツ（変更検出用）
- `dependencies` - 必要な依存モジュールの読み込み状態

## 公開関数

エディタは以下の主要関数を公開しています：

- `setupEditor(article, isNew)` - 記事データでエディタを初期化
- `updateArticleFromForm()` - フォームの入力から記事データを更新
- `hasUnsavedChanges()` - 未保存の変更があるかを確認
- `markdownToHtml(markdown)` - マークダウンをHTMLに変換（プレビュー用）
- `htmlToMarkdown(blocks)` - ブロック配列をマークダウンに変換
- `saveArticle()` - 記事を保存
- `previewArticle()` - 記事をプレビュー表示
- `cancelEditor()` - 編集をキャンセルして一覧に戻る

## 拡張機能

マークダウンエディタは以下の拡張機能を備えています：

### 1. シンタックスハイライト

マークダウン記法に色付けを行い、視認性を向上させます。

```javascript
function addSimpleSyntaxHighlighting() {
  // テキストエリアの上に透明なレイヤーを作成
  // 正規表現を使って異なるマークダウン要素に色を付ける
}
```

- 見出し、太字、斜体、コード、リンク、リストなどのマークダウン記法をハイライト表示
- テキストエリアの背後に透明な要素を配置し、入力テキストを装飾

### 2. リアルタイムプレビュー

マークダウン入力と結果のプレビューを切り替え表示できます。

```javascript
function addTogglePreview() {
  // プレビューモードと編集モードを切り替えるボタンと機能
}
```

- ツールバーの👁️ボタンでプレビューモードと編集モードを切り替え
- プレビューモードではマークダウンがHTMLにレンダリングされた状態で表示

### 3. 自動保存機能

一定時間入力がない場合に自動的に保存します。

```javascript
function addSimpleAutoSave() {
  // 入力後の一定時間後に保存処理を実行
  // 保存状態をステータス表示で通知
}
```

- 2秒間の入力がない状態でデバウンス処理により自動保存
- 保存状態（保存中、保存完了、保存失敗）を右下に通知表示

### 4. ショートカットキー

キーボードショートカットでマークダウン記法を素早く入力できます。

```javascript
function addBasicShortcuts() {
  // キーボードショートカットイベントを処理
  // ヘルプモーダルも提供
}
```

- Ctrl+B（太字）、Ctrl+I（斜体）、Ctrl+1〜3（見出し）など
- ?ボタンでショートカット一覧を表示

### 5. 行番号表示

エディタの左側に行番号を表示します。

```javascript
function addLineNumbers() {
  // テキストエリアの左側に行番号表示エリアを作成
  // テキスト入力やスクロールに合わせて同期
}
```

- テキストエリアのスクロールと同期して行番号も連動
- 長文編集時の位置把握をサポート

### 6. マークダウンガイド

マークダウン記法の参照ガイドを表示します。

```javascript
function addMarkdownGuide() {
  // マークダウン構文のリファレンスをモーダルで表示
}
```

- 📖ボタンでマークダウン記法ガイドをモーダル表示
- 見出し、テキスト装飾、リスト、リンク、コードなどの記法を解説

## 記事データ構造

マークダウンエディタで扱う記事データの構造は以下の通りです：

```javascript
{
  id: "article_1234567890",
  title: "記事タイトル",
  category: "カテゴリ名",
  author: "著者名",
  createdAt: "2023-04-01T12:00:00.000Z",
  updatedAt: "2023-04-02T15:30:00.000Z",
  tags: ["タグ1", "タグ2"],
  content: "# マークダウン形式の記事内容\n\nこれは段落です。"
}
```

`content`プロパティには、マークダウン形式のテキストが格納されます。以前のブロック形式から変換する場合は、`convertBlocksToMarkdown`関数を使用します。

## 初期化とセットアップ

エディタの初期化は以下の手順で行われます：

1. `DOMContentLoaded`イベントで初期処理を開始
2. 依存関係のチェック
3. 記事のリセットと初期状態の設定
4. イベントリスナーのセットアップ
5. 最後に編集していた記事の復元（LocalStorageから）
6. マークダウンエディタとツールバーの作成

## マークダウン変換

マークダウンとHTML間の変換は以下の関数で提供されます：

- `markdownToHtml(markdown)` - マークダウンをHTMLに変換（プレビュー用）
- `convertBlocksToMarkdown(blocks)` - 以前の形式（ブロック配列）からマークダウンに変換

## 使用例

エディタの基本的な使用例：

```javascript
// エディタ初期化
document.addEventListener('DOMContentLoaded', () => {
  // 既存記事を取得
  const article = await DB.get('article_123');
  
  // エディタセットアップ
  KB.editor.setupEditor(article);
  
  // 保存
  document.getElementById('save-button').addEventListener('click', () => {
    KB.editor.saveArticle();
  });
});
```

## 改善点とパフォーマンス最適化

editor.jsでは以下の改善が行われています：

1. **コードの最適化**: 重複コードの削除と関数の統合
2. **拡張性の向上**: 機能ごとにモジュール化された構造
3. **マークダウン処理の改善**: 正規表現を使った効率的な処理
4. **UI/UX向上**: ツールバー、シンタックスハイライト、プレビュー機能などの追加
5. **自動保存**: 入力に基づくデバウンス処理による自動保存機能
6. **キーボードショートカット**: 効率的な編集をサポート

## 注意事項

1. editor.jsが正常に動作するためには、schema.js、database.js、converter.jsなどの依存ファイルが必要です。
2. 外部ライブラリに依存せず、ピュアJavaScriptで実装されています。
3. editor.jsを変更する場合は、状態管理とイベントの伝播に注意してください。 