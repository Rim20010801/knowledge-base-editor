# ナレッジベースシステム要件定義ミーティング

## 議題：エディター機能と全体設計の方向性

### 現状分析

#### プロジェクト構成
- **Main/editor.html**: 記事編集ページ
- **Main/index.html**: メインページ（記事一覧・検索機能）
- **Main/js/**:
  - **core/**: コア機能（schema, database, converter, search など）
  - **ui/**: UI関連機能（editor.js）
  - **util/**: ユーティリティ（debounce, jsonHelper など）

#### 実装済み機能
- **データモデル**: schema.jsで記事構造定義（タイトル、カテゴリ、タグ、コンテンツブロック）
- **エディター機能**: マークダウン形式のエディタに移行済み
- **記事管理**: IndexDB保存、JSONエクスポート・インポート
- **UI**: モーダルウィンドウ、プレビュー機能、マークダウンツールバー

### 課題点
- editor.htmlとindex.htmlの役割分担が不明確
- コード重複（HTML変換処理など）
- モジュール間の依存関係が複雑

### 議論ポイント

#### 1. エディター設計
- [x] **マークダウン形式への移行**：
  - マークダウンの利点（シンプルな実装、テキスト操作の柔軟性、軽量、テキストベース、広く使われている）
  - 実装コード行数の削減と拡張性の向上
  - 後からブロックエディターを追加する段階的アプローチの採用
  - 既存ライブラリに依存せず、基本的な正規表現で自前実装
  - 既存データの変換方法と互換性の確保
  - ハイブリッドアプローチ（マークダウン+ブロック）の可能性→今後の拡張性
- [x] **画面遷移とユーザーフロー**：
  - 編集モードと閲覧モードを別ページとして実装（article.htmlとeditor.html）
  - 記事IDをURLパラメータとして受け渡し（例：editor.html?id=123）
  - プレビュー機能はモーダルウィンドウで実装
  - 編集履歴とバージョン管理の導入検討（一旦後で）

#### 2. アプリケーション構造
- [x] **アーキテクチャ選択**：
  - 複数ページ構成を採用（関心の分離、シンプルな実装）
  - 各ページが単一の責任を持つ設計
  - 共通機能はモジュール化して再利用
- [x] **ページ間の役割分担**：
  - index.html：記事一覧、検索、カテゴリ管理、タグ管理の専用ページ
  - article.html：記事閲覧に特化したページ
  - editor.html：記事作成・編集に特化した機能提供
  - 編集機能は閲覧画面から完全に分離し、編集ボタンで対応IDの記事を編集画面に渡す設計

#### 3. データフロー
- [x] **IndexDBと外部ストレージの連携**：
  - 同期タイミング：ハイブリッド方式（記事保存時・アプリ起動時の自動同期 + エクスポート/インポート機能での手動同期）
  - 競合解決戦略：タイムスタンプベース（最終更新日時記録、新しい方を優先）+ 競合検出時に差分表示UIでユーザー選択
  - メタデータ活用：編集デバイス名・編集日時を記録して判断材料に
- [x] **同時編集の制御機構**：
  - タイムスタンプによる単純な競合検出を基本実装
  - JSONファイルのエクスポート/インポートによる手動同期を基本機能として提供
  - 実装コストと機能性のバランスを考慮したシンプルな設計を採用
  - 排他制御（編集ロック機能）の導入を検討中
    - 記事データに「編集者ID」と「ロック時間」フィールドを追加
    - 編集開始時にロックをかけ、保存時に解除する仕組み
    - 一定時間経過でロック自動解除（タイムアウト機能）
    - データの整合性確保とユーザー体験向上のメリットあり

#### 4. 優先機能
- [x] **コア機能の定義**：
  - 記事のCRUD操作（作成、読取、更新、削除）の完全実装
  - 検索とフィルタリング（タグ、カテゴリ、全文検索）
  - インポート/エクスポート機能の堅牢化
- [x] **実装優先順位の決定基準**：
  - ユーザー価値に基づく優先順位付け（記事管理機能を最優先）
  - 技術的依存関係の考慮（データベース→API→UI の順で実装）
  - 短期目標：基本CRUD機能と検索機能の完成
  - 中期目標：同期機能とUIの改善
  - 長期目標：高度な検索と拡張機能の追加

#### 5. 技術的課題
- [x] **データ変換処理の改善**：
  - [x] JSON⇔HTML変換の効率化と堅牢性向上
    - 複雑な入れ子構造のJSONデータを正確にHTML要素に変換する処理の改善
    - 特殊文字やエスケープシーケンスの適切な処理方法の実装
    - 大量データ処理時のパフォーマンス最適化（メモリ使用量の削減）
  - [x] マークダウン変換処理の最適化
    - 独自拡張マークダウン記法のサポート（ブロック要素との連携）
    - 変換速度の向上（正規表現処理の効率化）
    - 画像や表などの複雑な要素の変換精度向上
  - [x] 変換エラー時の例外処理強化
    - エラー発生箇所の特定と詳細なログ出力機能
    - 部分的な変換失敗時のフォールバック機能（全体の処理を継続）
    - ユーザーへのわかりやすいエラーメッセージ表示と回復手順の提案
- [x] **検索エンジンの最適化**：
  - シンプルな全文検索の実装
  - タグ・カテゴリによる絞り込み機能の追加
  - 検索結果の表示順序とグループ化の改善
- [x] **同期メカニズムの詳細設計**：
  - JSONファイルのエクスポート/インポート機能の強化
  - タイムスタンプベースの競合解決の実装
  - 編集ロック機能の検討（オプション機能として）
  - シンプルで実用的な同期方法の優先実装

#### 6. UI/UX改善
- [x] **レスポンシブ対応の範囲と方針**：
  - デスクトップ環境を最優先（ウィンドウサイズ変更時のレイアウト崩れ防止程度）
  - 最小ウィンドウ幅の設定とそれに応じた要素の折り返し処理
  - タブレット・モバイルは当面対応しない方針
- [x] **エディター操作性の向上策**：
  - マークダウン編集に特化したショートカットキーの実装（太字、斜体、リスト、見出し等）
  - マウス操作の最適化（ドラッグ&ドロップ、右クリックメニュー）
  - マークダウン編集用ツールバーの設置（よく使う記法をボタン化）
  - 編集状態の視覚的フィードバック強化（保存通知、エラー表示の改善）

### 決定事項
- エディタ機能の優先実装順序：基本編集機能→マークダウン拡張
- IndexedDBをメインストレージとして採用、JSONエクスポート機能は補助的に位置づけ
- UIデザインはシンプルさを重視し、初期バージョンではミニマルなスタイルを採用
- 検索機能は基本的な全文検索とタグ検索を先行実装、高度な検索機能は後期開発に延期
- ブロックベースのエディタは実装しないことに決定（シンプルなマークダウンエディタに集中）

### 次のステップ
1. エディタコアモジュールの実装完了 **完了**
   - シンプルなマークダウンエディタの完成 **完了**
   - マークダウン⇔HTML変換処理の安定化 **完了**
2. 検索機能の基本実装（～1週間）
   - インデクサーの実装とテスト
   - 検索UIの改善
3. データ永続化機能の強化（～1週間）
   - IndexedDBスキーマの最終確定
   - バックアップ・リストア機能の実装

### メモ
- エディタUIはシンプルなマークダウン直接編集方式を採用
- パフォーマンス問題：大量記事（100件以上）の検索時に遅延発生、インデックス最適化が必要

## エディタ機能の実装状況と今後の計画

### 現状の実装状況
- [x] **基本的なエディタ機能**：
  - マークダウン形式での記事編集機能 **（実装完了）**
  - シンプルなテキストエディタとしての実装（ブロックベース方式は採用せず）
  - タイトル、カテゴリ、タグの設定機能
  - プレビュー機能の実装
  - 記事の保存・読み込み機能
  - マークダウンツールバーの実装
  - ブロック形式からマークダウン形式への変換機能

### 現在のファイル構成
- `editor.html`: エディタのメインUI
  - 記事情報入力フォーム（タイトル、カテゴリ、タグ）
  - マークダウン編集エリア
  - マークダウンツールバー（書式設定ボタン）
  - アクションボタン（保存、プレビュー、エクスポート、キャンセル）
  - プレビューモーダル

- `js/ui/editor.js`: エディタの機能実装
  - マークダウン編集機能（約500行に最適化）
  - マークダウン⇔HTML変換機能
  - ツールバー操作機能
  - タグ管理機能
  - プレビュー生成機能
  - 保存・キャンセル処理
  - 通知表示機能

### 最適化の内容
- **コード短縮**: 約700行から約500行へ削減
- **冗長性除去**: 共通処理のまとめ、重複コードの削減
- **機能統合**: 類似機能の統合、モジュール間のインターフェース簡略化
- **DOM操作の効率化**: テンプレートリテラルによるHTML生成の活用
- **処理フローの改善**: エラー処理とリカバリー機能の強化

### 改善が必要な点
1. **UIの一貫性と使いやすさ**:
   - シンタックスハイライトの追加
   - 編集中の自動保存機能の実装

2. **機能拡張**:
   - マークダウンのリアルタイムプレビュー
   - 画像参照機能の強化
   - テンプレート機能の追加

3. **パフォーマンス最適化**:
   - 大きな文書の編集時のパフォーマンス改善
   - 保存処理の非同期化と進捗表示

### 次期開発計画
1. **短期目標** (2週間以内):
   - マークダウンエディタのUI改善
   - ショートカットキーの実装
   - 自動保存機能の追加

2. **中期目標** (1ヶ月以内):
   - リアルタイムプレビュー機能
   - 画像参照機能の強化
   - 編集履歴機能の実装

3. **長期目標** (3ヶ月以内):
   - マークダウン拡張記法のサポート
   - バージョン管理システムの導入
   - 検索機能との連携強化


